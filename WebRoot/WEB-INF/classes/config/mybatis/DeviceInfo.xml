<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.Manage.dao.DeviceInfoDao">
	<resultMap type="DeviceInfo" id="DeviceInfo">
	</resultMap>
	<resultMap type="DeviceDealOrders" id="DeviceDealOrders">
	</resultMap>
    <resultMap type="DeviceUpgradingDTO" id="DeviceUpgradingDTO">
    </resultMap>
    <!-- 工厂测试记录表 -->
    <resultMap type="factoryTestInfoDTO" id="factoryTestInfoDTO"></resultMap>

	<sql id="queryPage_filter_sql">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN like '%${obj.SN}%'
      		]]>
		</if>
		<if test="obj.deviceStatus != null and obj.deviceStatus != '' ">
		<![CDATA[
      			and deviceStatus like '%${obj.deviceStatus}%'
        		]]>
		</if>
		<if test="obj.repertoryStatus != null and obj.repertoryStatus != '' ">
		<![CDATA[
      			and repertoryStatus like '%${obj.repertoryStatus}%'
        		]]>
		</if>
		<if test="obj.distributorID != null and obj.distributorID != '' ">
			<![CDATA[
	      			and distributorID like '%${obj.distributorID}'
	        ]]>
		</if>
	</sql>
	<!-- 查询所有设备信息数据 -->
	<select id="queryPage2" resultMap="DeviceInfo" parameterType="searchDTO">
		<![CDATA[
           SELECT  * FROM DeviceInfo  WHERE  sysStatus=1
     		]]>
		<include refid="queryPage_filter_sql" />
		GROUP BY SN
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate DESC</if>
		LIMIT #{startIndex},#{endIndex}
	</select>

	<!-- 查询总记录 -->
	<select id="getcount2" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      			select count(DISTINCT(SN)) from DeviceInfo where sysStatus=1
      	]]>
		<include refid="queryPage_filter_sql" />
	</select>

	<select id="getOnedevice" resultType="Integer">
		<![CDATA[
	       select count(*) from DeviceInfo where SN=#{sn}
	    ]]>
	</select>
	<select id="getOnedevice1" resultType="DeviceInfo">
		<![CDATA[
		       select * from DeviceInfo where SN=#{SN} and  sysStatus = 1
		]]>
	</select>
	<!-- 统计设备 -->
	<sql id="queryPage_filter_sql_count">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and creatorDate between #{obj.creatorDate} and #{obj.creatorDate2}
      		]]>
		</if>
	</sql>
	<!--=========================== 设备统计============================ -->
	<select id="getDeviceCount" resultType="DeviceInfo"
		parameterType="DeviceInfo">
	<![CDATA[
	       SELECT
	       (SELECT COUNT(*) FROM DeviceInfo)AS allDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE deviceStatus='可使用' AND repertoryStatus='入库' and sysStatus=1)AS kyDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE repertoryStatus='出库') AS chDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE deviceStatus='不可用' AND repertoryStatus='维修' AND sysStatus=1) AS wxDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus=0) AS deleDevice
	       FROM DeviceInfo
	       ]]>
		GROUP BY allDevice LIMIT 1
	</select>
	<!-- ======================================== -->

	<!-- 插入设备信息数据 -->
	<insert id="insertdevice" parameterType="DeviceInfo"
		useGeneratedKeys="true" keyProperty="deviceID">
		insert into DeviceInfo(deviceID,
		CardID,SN, deviceColour,distributorID,distributorName,
		remark,creatorUserID,creatorUserName, creatorDate,supportCountry,modelNumber,frequencyRange)
		values(#{deviceID},#{CardID},#{SN},#{deviceColour},#{distributorID},#{distributorName},
		#{remark},#{creatorUserID},#{creatorUserName},now(),#{supportCountry},#{modelNumber},#{frequencyRange});
	</insert>


	<insert id="insertdevicetwo" parameterType="DeviceInfo"
		useGeneratedKeys="true" keyProperty="deviceID">
		insert into DeviceInfo(deviceID,
		CardID,SN,
		deviceColour,distributorID,distributorName,deviceStatus,remark,creatorUserID,creatorUserName,
		creatorDate)
		values(#{deviceID},#{CardID},#{SN},#{deviceColour},#{distributorID},#{distributorName},#{deviceStatus},#{remark},#{creatorUserID},#{creatorUserName},#{creatorDate});
	</insert>
	<insert id=""></insert>

	<update id="ToupdateDevice" parameterType="DeviceInfo">
		update DeviceInfo set
		deviceStatus=#{deviceStatus},
<!-- 		repertoryStatus=#{repertoryStatus}, -->
		modifyUserID=#{modifyUserID},
		modifyDate=#{modifyDate}
		where SN=#{SN}
	</update>

	<!-- 删除 -->
	<update id="getDeleteDeviceInfo" parameterType="DeviceInfo">
		update DeviceInfo
		set sysStatus=0 where SN=#{SN}
	</update>

	<update id="DeviceInfostatus" parameterType="DeviceInfo">
		update DeviceInfo set
		deviceStatus=#{deviceStatus},cardID=#{cardID},remark=#{remark},repertoryStatus=#{repertoryStatus},
		supportCountry=#{supportCountry},modelNumber=#{modelNumber},frequencyRange=#{frequencyRange},modifyUserID=#{modifyUserID},modifyDate=now() where SN=#{SN}
	</update>
	<update id="updatedevicestatus" parameterType="DeviceInfo">
		update DeviceInfo set deviceStatus=#{deviceStatus} where SN=#{SN}
	</update>
	<!-- <update id="updatedevicestatus2" parameterType="DeviceInfo">
		update DeviceInfo set deviceStatus=#{deviceStatus} where orderID=#{orderID}
	</update> -->
	<!-- 修改设备订单表状态 -->
	<update id="ToupdateDeviceDealOrders" parameterType="DeviceDealOrders">
		update DeviceDealOrders set
		ifReturn=#{ifReturn},orderStatus=#{orderStatus},modifyUserID=#{modifyUserID},
		modifyDate=#{modifyDate},IfFinish=#{IfFinish},returnDate=now()
		where SN=#{SN}
	</update>

	<select id="getOnedeviceInfo" parameterType="DeviceInfo"
		resultType="DeviceInfo">
		select * from DeviceInfo where SN = #{SN} and sysStatus=1
	</select>

	<update id="ToupdateDeviceDealOrders2" parameterType="Integer">
		<![CDATA[
		update DeviceDealOrders set ifReturn=#{ifReturn},modifyUserID=#{modifyUserID},modifyDate=#{modifyDate}
		where SN=#{SN}
			]]>
	</update>

	<!-- ===============search delete data start========================= -->
	<sql id="queryPage_filter_sql2">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN like '%${obj.SN}%'
      		]]>
		</if>
	</sql>

	<select id="queryPagedelete" resultMap="DeviceInfo"
		parameterType="searchDTO">
		<![CDATA[
		 SELECT * FROM DeviceInfo WHERE sysStatus=0
     		]]>
		<include refid="queryPage_filter_sql2" />
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		<if test="sortOrder == 'desc'"> DESC </if>
		<if test="sortOrder == 'asc'"> ASC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>

	<!-- 查询总记录 -->
	<select id="getcountdelete" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      			select count(*) from DeviceInfo where sysStatus=0
      	]]>
		<include refid="queryPage_filter_sql2" />
	</select>
	<!-- ===============search delete data end========================= -->

	<!-- wangbo 所加 begin -->

	<sql id="queryPage_filter_sql3">
		<if test=" obj!=null and obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN = #{obj.SN}
      		]]>
		</if>
		<if
			test="obj!=null and obj.deviceStatus != null and obj.deviceStatus != '' ">
		<![CDATA[
     			and deviceStatus = #{obj.deviceStatus}
      		]]>
		</if>
		<if test="obj==null or obj.sysStatus == null or obj.sysStatus == '' ">
		<![CDATA[
     			and sysStatus = 1
      		]]>
		</if>
		<if test="obj!=null and obj.sysStatus != null and obj.sysStatus != '' ">
		<![CDATA[
     			and sysStatus = #{obj.sysStatus}
      		]]>
		</if>
	</sql>

	<!-- 分页查询设备记录 -->
	<select id="selectpage" resultMap="DeviceInfo" parameterType="searchDTO">
		<![CDATA[
		 select * from DeviceInfo where 1=1
     		]]>
		<include refid="queryPage_filter_sql3" />
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		<if test="sortOrder == 'desc'"> DESC </if>
		<if test="sortOrder == 'asc'"> ASC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>

	<select id="getdevcount" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      	select count(*) from DeviceInfo  where 1=1
    ]]>
		<include refid="queryPage_filter_sql3" />
	</select>
	<!-- 根据SN查询设备信息 -->
	<select id="getbysn" resultMap="DeviceInfo" parameterType="String">
		select * from DeviceInfo where sysStatus=1 and SN=#{SN}
	</select>

	<!-- wangbo 所加 end -->

	<!-- ============================== -->
	<sql id="queryPage_filter_sqlCountend">
		<!-- <if test="obj.creatorDate != null and obj.creatorDate != '' and obj.modifyDate
			!= null and obj.modifyDate != ''"> -->
		<![CDATA[
     			and creatorDate >= #{obj.creatorDate} and creatorDate <= #{obj.modifyDate}
      		]]>
		<!-- </if> -->
	</sql>
	<select id="getCountTimes" resultMap="DeviceInfo">
	<![CDATA[
	       SELECT
	       (SELECT COUNT(*) FROM DeviceInfo WHERE SN IS NOT NULL
	       ]]>
		<include refid="queryPage_filter_sqlCountend" />
	       <![CDATA[
	       )AS allDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE deviceStatus='可使用' AND repertoryStatus='入库' and sysStatus=1
	       ]]>
		<include refid="queryPage_filter_sqlCountend" />
	       <![CDATA[
	       )AS kyDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE repertoryStatus='出库'
	       	]]>
		<include refid="queryPage_filter_sqlCountend" />
	       <![CDATA[
	       ) AS chDevice,
	       (SELECT COUNT(*) FROM DeviceInfo WHERE deviceStatus='不可用' AND repertoryStatus='维修' AND sysStatus=1
	       ]]>
		<include refid="queryPage_filter_sqlCountend" />
		) AS wxDevice,
	       <![CDATA[
	       (SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus=0
	        ]]>
		<include refid="queryPage_filter_sqlCountend" />
		) AS deleDevice FROM DeviceInfo GROUP BY allDevice LIMIT 1
	</select>

	<!-- 下拉显示设备状态是否可用 -->
	<select id="getDeviceTypes" parameterType="Dictionary"
		resultType="Dictionary">
	  <![CDATA[
      SELECT label FROM Dict WHERE description='设备状态' ORDER BY sort ASC
      ]]>
	</select>
	<!-- 登录首页设备统计 -->
	<select id="statistics" resultType="map" parameterType="DeviceInfo">
		SELECT
		(SELECT COUNT(*) FROM DeviceInfo WHERE repertoryStatus='入库' AND
		deviceStatus='可使用' AND sysStatus='1') AS rkDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE deviceStatus='使用中' AND sysStatus='1')
		AS chDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus='1' AND deviceStatus='不可用')
		AS wxDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus='1') AS allDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus='1' AND deviceStatus='可使用')
		AS kyDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus='1' AND deviceStatus='不可用')
		AS bkyDevice,
		(SELECT COUNT(*) FROM DeviceInfo WHERE sysStatus='0') AS deleDevice
		FROM DeviceInfo GROUP BY allDevice LIMIT 1
	</select>

	<sql id="queryPage_filter_devicecount">
		<if
			test="begindate !=null and begindate !=''  and enddate!=null and enddate !=''">
		<![CDATA[
			 and creatorDate >=#{begindate} and creatorDate <=#{enddate}
		]]>
		</if>
		<if
			test="deviceStatus !=null and deviceStatus != '' and repertoryStatus != null and repertoryStatus != ''">
		<![CDATA[
			and deviceStatus=#{deviceStatus} and repertoryStatus=#{repertoryStatus}
		]]>
		</if>
		<if test="repertoryStatus !=null and repertoryStatus !=''">
		<![CDATA[
			and repertoryStatus = #{repertoryStatus}
		]]>
		</if>
		<if
			test="deviceStatus !=null and deviceStatus !='' and repertoryStatus !=null and repertoryStatus !=''">
		<![CDATA[
			and deviceStatus=#{deviceStatus} and repertoryStatus=#{repertoryStatus} and sysStatus=1
		]]>
		</if>
		<if test="sysStatus !=null and sysStatus !=''">
		<![CDATA[
			and sysStatus=#{sysStatus}
		]]>
		</if>
	</sql>
	<select id="devicecount" resultType="Integer" parameterType="DeviceInfo">
		SELECT COUNT(*) FROM DeviceInfo where 1=1
		<include refid="queryPage_filter_devicecount" />
	</select>


	<select id="searchDevice" resultType="Integer" parameterType="DeviceDealOrders">
	<![CDATA[
      	SELECT COUNT(*) FROM DeviceDealOrders  WHERE SN=#{SN} AND deallType=#{deallType} and sysStatus=1
    ]]>
	</select>

	<select id="searchDevice2" resultType="Integer" parameterType="DeviceDealOrders">
	<![CDATA[
      	SELECT COUNT(*) FROM DeviceDealOrders  WHERE SN=#{SN} and sysStatus=1
    ]]>
	</select>


	<select id="searchDeviceInfoTypeforSn" resultType="String" parameterType="DeviceInfo">
	<![CDATA[
      	SELECT deviceStatus FROM DeviceInfo  WHERE SN=#{SN} and sysStatus=1
    ]]>
	</select>

	<!-- 设备归还时该状态 -->
	<update id="updateReturn" parameterType="String">
		update DeviceInfo set deviceStatus = '可使用' where sysStatus=1 and SN = #{SN} and deviceStatus='使用中'
	</update>


	<!-- 下设备订单后将设备状态改为使用中 -->
	<update id="updateDeviceOrder" parameterType="String">
		update DeviceInfo set deviceStatus='使用中' where sysStatus=1 and SN=#{_parameter}
	</update>
	<select id="forsncount" resultType="Integer">
		select count(*) FROM DeviceInfo where SN=#{SN}
	</select>
	<!--查找流量订单对应的设备订单，设备订单SN更新为输入的SN -->
	<update id="updateSN" parameterType="DeviceDealOrders">
		update DeviceDealOrders set SN = #{SN},modifyDate=now(),modifyUserID=#{modifyUserID} where orderID=#{orderID};
	</update>


	<select id="getonebysn" resultType="String" parameterType="DeviceInfo">
	<![CDATA[
      	SELECT deviceStatus FROM DeviceInfo  WHERE SN=#{SN} and sysStatus=1
    ]]>
	</select>

	<select id="searchDevicekeshiyong" resultType="Integer" parameterType="DeviceDealOrders">
		SELECT COUNT(*) FROM DeviceDealOrders WHERE SN=#{SN} AND sysStatus=1
	</select>

	<select id="searchfdInfo" resultMap="DeviceInfo" parameterType="DeviceInfo">
		select * from DeviceInfo where SN = #{SN} and sysStatus=1 limit 1
	</select>
	<update id="deviceDistribute" parameterType="DeviceInfo">
		UPDATE DeviceInfo SET distributorID = #{distributorID},distributorName=#{distributorName} where SN = #{SN}
	</update>


	<sql id="queryPage_filter_sql4">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN like '%${obj.SN}%'
      		]]>
		</if>
		<if test="obj.distributorID != null and obj.distributorID != '' ">
			<![CDATA[
	      		and distributorID like '%${obj.distributorID}%'
	        ]]>
		</if>
	</sql>

	<select id="queryPage" resultMap="DeviceInfo" parameterType="searchDTO" >
		<![CDATA[
      	SELECT * FROM DeviceInfo  where sysStatus=1
    ]]>
    <include refid="queryPage_filter_sql4" />
    order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null">creatorDate DESC</if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		 <if test="sortOrder == 'desc'"> DESC </if>
		 <if test="sortOrder == 'asc'"> ASC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>
	<select id="getcount" resultType="Integer" parameterType="searchDTO">
		<![CDATA[
      	SELECT count(*) FROM DeviceInfo where sysStatus=1
    ]]>
    <include refid="queryPage_filter_sql4" />
	</select>
	<select id="selectsnDistributor" parameterType="DeviceInfo" resultMap="DeviceInfo" >
		select * from DeviceInfo where 	sysStatus =1 and SN=#{SN}
	</select>
	<update id="deldistributorID" parameterType="DeviceInfo">
		<![CDATA[
	      	update DeviceInfo set distributorID = '',distributorName='' where deviceID=#{deviceID}
	    ]]>
	</update>

	<select id="ckqdsforsn" parameterType="DeviceInfo" resultType="Integer">
	  select count(*) from DeviceInfo where sysStatus=1 and SN=#{SN} and distributorID=#{distributorID}
	</select>
	<update id="updateRemark" parameterType="DeviceInfo">
		<![CDATA[
	      	update DeviceInfo set SN=#{SN}
	    ]]>
	    <if test="remark !=null and remark !=''">
		<![CDATA[
			,remark=#{remark}
		]]>
		</if>
		<if test="deviceColour !=null and deviceColour !=''">
		<![CDATA[
			,deviceColour=#{deviceColour}
		]]>
		</if>
	    where SN=#{SN}
	</update>
	<select id="selectDeviceInfoByDis" parameterType="DeviceInfo" resultMap="DeviceInfo">
		select * from DeviceInfo where sysStatus=1 and SN=#{SN} and distributorID=#{distributorID}
	</select>

	<select id="queryPage2kucun" resultMap="DeviceInfo" parameterType="searchDTO">
				<![CDATA[
				SELECT d.SN,d.deviceStatus,d.repertoryStatus,
                       dorder.SN,dorder.deallType,dorder.orderID,dorder.ifReturn,
                       Shipm.shipmentDate,Shipm.recipientName,Shipm.remark as remarkcrk
                FROM DeviceInfo d
                LEFT JOIN
                     (SELECT de.SN,de.deallType,de.orderID,de.ifReturn FROM DeviceDealOrders de WHERE NOT EXISTS(SELECT 1 FROM DeviceDealOrders WHERE SN=de.SN AND creatorDate>de.creatorDate AND sysStatus=1)and de.sysStatus=1)  dorder
                    ON(d.SN=dorder.SN)
                LEFT JOIN
                     (SELECT sp.SN,sp.shipmentDate,sp.recipientName,sp.remark  FROM Shipment sp WHERE NOT EXISTS(SELECT 1 FROM Shipment WHERE SN = sp.SN AND creatorDate>sp.creatorDate AND sysStatus=1) and sp.sysStatus=1) Shipm
                    ON(d.SN = Shipm.SN)
                 WHERE d.sysStatus=1 and (d.distributorID='' OR  ISNULL(d.distributorID))
                ]]>
                  <include refid="queryPage_filter_sql_kucun" />
              GROUP BY d.SN
		       order by
		          <if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> d.creatorDate DESC</if>
		     LIMIT #{startIndex},#{endIndex}
	</select>
	<select id="getcount2kucun" resultType="Integer" parameterType="searchDTO"><!-- 查询库存总数 -->
	<![CDATA[
           SELECT COUNT(DISTINCT(d.SN))
                  FROM DeviceInfo d
           LEFT JOIN
                 (SELECT de.SN,de.deallType,de.orderID FROM DeviceDealOrders de WHERE NOT EXISTS(SELECT 1 FROM DeviceDealOrders WHERE SN=de.SN AND creatorDate>de.creatorDate AND sysStatus=1)AND de.sysStatus=1)  dorder
           ON(d.SN=dorder.SN)
           LEFT JOIN
                 (SELECT sp.SN,sp.shipmentDate,sp.recipientName,sp.remark  FROM Shipment sp WHERE NOT EXISTS(SELECT 1 FROM Shipment WHERE SN = sp.SN AND creatorDate>sp.creatorDate AND sysStatus=1)AND sp.sysStatus=1) Shipm
           ON(d.SN = Shipm.SN)
           WHERE d.sysStatus=1 and (d.distributorID='' OR  ISNULL(d.distributorID))
      	]]>
		<include refid="queryPage_filter_sql_kucun" />
	</select>

	<sql id="queryPage_filter_sql_kucun">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and d.SN like '%${obj.SN}%'
      		]]>
		</if>
		<if test="obj.deviceStatus != null and obj.deviceStatus != '' ">
		<![CDATA[
      			and d.deviceStatus = #{obj.deviceStatus}
        		]]>
		</if>
		<if test="obj.deallType != null and obj.deallType != '' ">
			<![CDATA[
	      			and dorder.deallType = #{obj.deallType}
	        ]]>
		</if>
		<if test="obj.repertoryStatus != null and obj.repertoryStatus != '' ">
			<![CDATA[
	      			and d.repertoryStatus = #{obj.repertoryStatus}
	        ]]>
		</if>
	</sql>


<select id="queryPage2getygqSN" resultMap="DeviceInfo" parameterType="searchDTO">
	 <![CDATA[
	 SELECT flowOrder.SN,flowOrder.orderID,flowOrder.orderStatus,flowOrder.creatorDate,
deviceOrder.SN,deviceOrder.orderID,deviceOrder.ifReturn,deviceOrder.deallType,
Shipm.SN,Shipm.recipientName,Shipm.shipmentDate,Shipm.remark,device.distributorID
FROM (SELECT fo.SN,fo.orderID,fo.orderStatus,fo.sysStatus,fo.creatorDate FROM FlowDealOrders fo WHERE NOT EXISTS(SELECT 1 FROM FlowDealOrders WHERE SN=fo.SN AND creatorDate>fo.creatorDate AND sysStatus=1)AND fo.sysStatus=1) flowOrder
LEFT JOIN
(SELECT de.SN,de.orderID,de.ifReturn,de.deallType FROM DeviceDealOrders de WHERE NOT EXISTS(SELECT 1 FROM DeviceDealOrders WHERE SN=de.SN AND creatorDate > de.creatorDate AND sysStatus=1)AND de.sysStatus=1) deviceOrder
ON (flowOrder.SN = deviceOrder.SN)
LEFT JOIN
(SELECT sp.SN,sp.recipientName,sp.shipmentDate,sp.remark FROM Shipment sp WHERE NOT EXISTS(SELECT 1 FROM Shipment WHERE SN=sp.SN AND creatorDate>sp.creatorDate AND sysStatus=1)AND sp.sysStatus=1) Shipm
ON(flowOrder.SN = Shipm.SN)
LEFT JOIN (SELECT d.SN,d.distributorID FROM DeviceInfo d WHERE d.sysStatus=1) device
ON(flowOrder.SN=device.SN)
WHERE LENGTH(flowOrder.SN)=15 AND flowOrder.sysStatus=1 AND flowOrder.orderStatus='已过期' AND deviceOrder.ifReturn='否' AND deviceOrder.deallType='租用' AND flowOrder.orderID!='10086'
AND (device.distributorID='' OR  ISNULL(device.distributorID))
     ]]>
     <include refid="queryPage_filter_sql_getygqSN" />
		GROUP BY flowOrder.SN
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> flowOrder.creatorDate DESC</if>
		LIMIT #{startIndex},#{endIndex}
 </select>

		<!-- 查询总记录 -->
	<select id="getcount2getygqSN" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      	 SELECT COUNT(DISTINCT(flowOrder.SN))
FROM (SELECT fo.SN,fo.orderID,fo.orderStatus,fo.sysStatus FROM FlowDealOrders fo WHERE NOT EXISTS(SELECT 1 FROM FlowDealOrders WHERE SN=fo.SN AND creatorDate>fo.creatorDate AND sysStatus=1)AND fo.sysStatus=1) flowOrder
LEFT JOIN
(SELECT de.SN,de.orderID,de.ifReturn,de.deallType FROM DeviceDealOrders de WHERE NOT EXISTS(SELECT 1 FROM DeviceDealOrders WHERE SN=de.SN AND creatorDate > de.creatorDate AND sysStatus=1) AND de.sysStatus=1) deviceOrder
ON (flowOrder.SN = deviceOrder.SN)
LEFT JOIN
(SELECT sp.SN,sp.recipientName,sp.shipmentDate,sp.remark FROM Shipment sp WHERE NOT EXISTS(SELECT 1 FROM Shipment WHERE SN=sp.SN AND creatorDate>sp.creatorDate AND sysStatus=1)AND sp.sysStatus=1) Shipm
ON(flowOrder.SN = Shipm.SN)
LEFT JOIN (SELECT d.SN,d.distributorID FROM DeviceInfo d WHERE d.sysStatus=1) device
ON(flowOrder.SN=device.SN)
WHERE LENGTH(flowOrder.SN)=15 AND flowOrder.sysStatus=1 AND flowOrder.orderStatus='已过期' AND deviceOrder.ifReturn='否' AND deviceOrder.deallType='租用' AND flowOrder.orderID!='10086'
AND (device.distributorID='' OR  ISNULL(device.distributorID))
      	]]>
      	     <include refid="queryPage_filter_sql_getygqSN" />
	</select>

    <sql id="getUpgradePage_filter_sql">
        <if test="obj.SN != null and obj.SN != '' ">
            and SN like '%${obj.SN}%'
        </if>
        <if test="obj.ifUpdated != null ">
            and ifUpdated = ${obj.ifUpdated}
        </if>
        <if test="obj.begainTime != null and obj.begainTime != '' ">
            <![CDATA[and creatorDate >= #{obj.begainTime} ]]>
        </if>
        <if test="obj.endTime != null and obj.endTime != '' ">
            <![CDATA[and creatorDate <= #{obj.endTime} ]]>
        </if>
        <if test="obj.creatorUserName != null and obj.creatorUserName != '' ">
            and creatorUserName like '%${obj.creatorUserName}%'
        </if>
        <if test="obj.updateSource != null">
        	<if test="obj.updateSource == 0">
        		and (updateSource is null or updateSource =0 or updateSource =2) 
        	</if>
        	<if test="obj.updateSource == 1">
        		and updateSource =#{obj.updateSource}
        	</if>
        </if>
    </sql>

	<!-- 分页查询设备升级配置信息 -->
	<select id="getUpgradePage" resultMap="DeviceUpgradingDTO" parameterType="searchDTO">
	   select * from DeviceUpgrading where sysStatus=1
	   <include refid="getUpgradePage_filter_sql"></include>
	   order by creatorDate desc
	   LIMIT #{startIndex},#{endIndex}
	</select>
    <select id="getUpgradeCount" resultType="Integer" parameterType="searchDTO">
        select count(1) from DeviceUpgrading where sysStatus=1
       <include refid="getUpgradePage_filter_sql"></include>
    </select>
	<!-- 不分页查询设备升级配置信息 -->
	<sql id="getUpgrade_sql">
		<where>
			<if test="1 ==1 ">
				and sysStatus=1
				and (updateSource !=1 or updateSource is null)
			</if>
			<if test=" sn != null and sn != '' ">
				and SN=#{sn}
			</if>
			<if test=" ifUpdated != null and ifUpdated != '' ">
				and ifUpdated=#{ifUpdated}
			</if>
		</where>
	</sql>
	<select id="getUpgrade" resultMap="DeviceUpgradingDTO" parameterType="map">
	   select * from DeviceUpgrading  
	   <include refid="getUpgrade_sql"></include>
	   order by creatorDate desc
	</select>

    <select id="getygqSNdevice" resultMap="DeviceInfo" parameterType="DeviceInfo">
         <![CDATA[
           SELECT d.SN,de.orderID,s.recipientName,s.remark,s.shipmentDate
            FROM
               DeviceInfo d LEFT JOIN DeviceDealOrders de ON(d.SN=de.SN)
                            LEFT JOIN FlowDealOrders fl ON(de.SN = fl.SN AND de.orderID = fl.orderID)
                            LEFT JOIN Shipment s ON(s.SN = fl.SN)
           WHERE
               de.sysStatus=1 AND (d.distributorID='' OR  ISNULL(d.distributorID)) AND ifReturn='否' AND LENGTH(d.SN)=15
               AND fl.orderID!='10086' AND fl.orderStatus='已过期'
     ]]>
		GROUP BY de.SN
		order by  de.creatorDate,s.creatorDate DESC
     </select>

<sql id="queryPage_filter_sql_getygqSN">
      <if test="obj.SN != null and obj.SN != '' ">
			<![CDATA[
	      			and flowOrder.SN = #{obj.SN}
	        ]]>
		</if>
</sql>
    <!-- 新增设备升级配置信息 -->
    <insert id="insertSelective" parameterType="com.Manage.entity.DeviceUpgrading">
        insert into DeviceUpgrading
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="deviceUpgradingID != null" >
               deviceUpgradingID,
            </if>
            <if test="SN != null" >
               SN,
            </if>
            <if test="upgradeFileType != null" >
               upgradeFileType,
            </if>
            <if test="ifForcedToUpgrade != null" >
               ifForcedToUpgrade,
            </if>
            <if test="ifUpdated != null" >
               ifUpdated,
            </if>
            <if test="updateDate != null" >
               updateDate,
            </if>
            <if test="remark != null" >
               remark,
            </if>
            <if test="creatorUserID != null" >
		       creatorUserID,
		    </if>
		    <if test="creatorDate != null" >
		       creatorDate,
		    </if>
		    <if test="creatorUserName != null" >
		       creatorUserName,
		    </if>
		    <if test="modifyUserID != null" >
		       modifyUserID,
		    </if>
		    <if test="modifyDate != null" >
		       modifyDate,
		    </if>
		    <if test="sysStatus != null" >
		       sysStatus,
		    </if>
		    <if test="updateSource != null" >
		       updateSource,
		    </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="deviceUpgradingID != null" >
               #{deviceUpgradingID},
            </if>
            <if test="SN != null" >
               #{SN},
            </if>
            <if test="upgradeFileType != null" >
               #{upgradeFileType},
            </if>
            <if test="ifForcedToUpgrade != null" >
               #{ifForcedToUpgrade},
            </if>
            <if test="ifUpdated != null" >
               #{ifUpdated},
            </if>
            <if test="updateDate != null" >
               now(),
            </if>
            <if test="remark != null" >
               #{remark},
            </if>
            <if test="creatorUserID != null" >
               #{creatorUserID},
            </if>
            <if test="creatorDate != null" >
               now(),
            </if>
            <if test="creatorUserName != null" >
               #{creatorUserName},
            </if>
            <if test="modifyUserID != null" >
               #{modifyUserID},
            </if>
            <if test="modifyDate != null" >
               #{modifyDate},
            </if>
            <if test="sysStatus != null" >
               #{sysStatus},
            </if>
             <if test="updateSource != null" >
		       #{updateSource},
		    </if>
        </trim>
    </insert>

    <update id="updateSelective" parameterType="com.Manage.entity.DeviceUpgrading">
        update DeviceUpgrading
	    <set >
	      <if test="SN != null" >
	       SN = #{SN},
	      </if>
	      <if test="upgradeFileType != null" >
	       upgradeFileType = #{upgradeFileType},
	      </if>
	      <if test="ifForcedToUpgrade != null" >
	       ifForcedToUpgrade = #{ifForcedToUpgrade},
	      </if>
	      <if test="ifUpdated != null" >
	       ifUpdated = #{ifUpdated},
	      </if>
	      <if test="updateDate != null" >
	       updateDate =	now(),
	      </if>
	      <if test="remark != null" >
	       remark = #{remark},
	      </if>
	      <if test="creatorUserID != null" >
	       creatorUserID = #{creatorUserID},
	      </if>
	      <if test="creatorDate != null" >
	       creatorDate = #{creatorDate},
	      </if>
	      <if test="creatorUserName != null" >
	       creatorUserName = #{creatorUserName},
	      </if>
	      <if test="modifyUserID != null" >
	       modifyUserID = #{modifyUserID},
	      </if>
	      <if test="modifyDate != null" >
	       modifyDate = #{modifyDate},
	      </if>
	      <if test="sysStatus != null" >
	       sysStatus = #{sysStatus},
	      </if>
	    </set>
	    where deviceUpgradingID = #{deviceUpgradingID} and sysStatus=1
    </update>

    <!-- 更新设备更新配置信息状态为已删除 -->
    <update id="updateUpgradeStatus" parameterType="java.util.List">
        update DeviceUpgrading set sysStatus=0 where deviceUpgradingID in
        <foreach collection="list" item = "model" open="(" separator="," close=")">
            #{model}
        </foreach>
    </update>

    <!-- ahming adds and sysStatus=1 -->
    <select id="getNotUpdatedBySN" resultMap="DeviceUpgradingDTO" parameterType="java.lang.String">
        select * from DeviceUpgrading where SN=#{SN} and ifUpdated=0 and sysStatus=1 
        and (updateSource is null or updateSource =0) order by creatorDate desc LIMIT 1
    </select>
    
  <!--    <select id="getNotUpdatedBySNone" resultMap="DeviceUpgradingDTO" parameterType="java.lang.String">
        select * from DeviceUpgrading where SN=#{SN} and ifUpdated=0 and sysStatus=1 LIMIT 1
    </select> -->

    <select id="getAllUpdatingBySN" resultMap="DeviceUpgradingDTO" parameterType="java.lang.String">
        select * from DeviceUpgrading where SN=#{SN} and sysStatus=1
    </select>

	<!-- 更新设备配置信息(设置更新状态为已更新) ahming adds and ifUpdated=0 -->
	<update id="updateUpgradeSuccess" parameterType="java.lang.String">
        update DeviceUpgrading set ifUpdated=1,modifyDate=now(),updateDate=now() where SN=#{SN} and ifUpdated=0 and sysStatus=1 order by creatorDate desc
    </update>
    <update id="updateUpgradeSuccessForPortal" parameterType="DeviceUpgradingDTO">
        UPDATE DeviceUpgrading
		SET ifUpdated = 1,
 			modifyDate = now(),
		 	updateDate = now()
		WHERE SN = #{SN} 
		AND ifUpdated = 0
		AND sysStatus = 1
		AND updateSource=1
		AND upgradeFileType=#{upgradeFileType}
		ORDER BY
			creatorDate DESC
		LIMIT 1
    </update>
	


    <insert id="insertFactorySelective" parameterType="com.Manage.entity.FactoryTestInfo">
        insert into FactoryTestInfo
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="SN != null" >
               SN,
            </if>
            <if test="SSID != null" >
               SSID,
            </if>
            <if test="roam_appVersionNum != null" >
               roam_appVersionNum,
            </if>
            <if test="roam_apkVersionNum != null" >
               roam_apkVersionNum,
            </if>
            <if test="roam_IMEI != null" >
               roam_IMEI,
            </if>
            <if test="roam_SN != null" >
               roam_SN,
            </if>
            <if test="roam_ICCID != null" >
               roam_ICCID,
            </if>
            <if test="roam_SIMStatus != null" >
               roam_SIMStatus,
            </if>
            <if test="roam_calibrationMark != null" >
               roam_calibrationMark,
            </if>
            <if test="roam_networkType != null" >
               roam_networkType,
            </if>
            <if test="roam_networkStrength != null" >
               roam_networkStrength,
            </if>
            <if test="roam_dataConnectionStatus != null" >
               roam_dataConnectionStatus,
            </if>
            <if test="local_wifiPwd != null" >
               local_wifiPwd,
            </if>
            <if test="local_appVersionNum != null" >
               local_appVersionNum,
            </if>
            <if test="local_apkVersionNum != null" >
               local_apkVersionNum,
            </if>
            <if test="local_IMEI != null" >
               local_IMEI,
            </if>
            <if test="local_SN != null" >
               local_SN,
            </if>
            <if test="local_ICCID != null" >
               local_ICCID,
            </if>
            <if test="local_SIMStatus != null" >
               local_SIMStatus,
            </if>
            <if test="local_calibrationMark != null" >
               local_calibrationMark,
            </if>
            <if test="local_networkType != null" >
               local_networkType,
            </if>
            <if test="local_networkStrength != null" >
               local_networkStrength,
            </if>
            <if test="local_dataConnectionStatus != null" >
               local_dataConnectionStatus,
            </if>
            <if test="local_serialComTest != null" >
               local_serialComTest,
            </if>
            <if test="upload_networkedTestResult != null" >
               upload_networkedTestResult,
            </if>
            <if test="result != null" >
               result,
            </if>
            <if test="creatorUserID != null" >
               creatorUserID,
            </if>
            <if test="creatorDate != null" >
               creatorDate,
            </if>
            <if test="creatorUserName != null" >
               creatorUserName,
            </if>
            <if test="modifyUserID != null" >
               modifyUserID,
            </if>
            <if test="modifyDate != null" >
               modifyDate,
            </if>
            <if test="sysStatus != null" >
               sysStatus,
            </if>
            <if test="installCard != null" >
               installCard,
            </if>
            <if test="gps != null" >
               gps,
            </if>
            <if test="power != null" >
               power,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="SN != null" >
               #{SN},
            </if>
            <if test="SSID != null" >
               #{SSID},
            </if>
            <if test="roam_appVersionNum != null" >
               #{roam_appVersionNum},
            </if>
            <if test="roam_apkVersionNum != null" >
               #{roam_apkVersionNum},
            </if>
            <if test="roam_IMEI != null" >
               #{roam_IMEI},
            </if>
            <if test="roam_SN != null" >
               #{roam_SN},
            </if>
            <if test="roam_ICCID != null" >
               #{roam_ICCID},
            </if>
            <if test="roam_SIMStatus != null" >
               #{roam_SIMStatus},
            </if>
            <if test="roam_calibrationMark != null" >
               #{roam_calibrationMark},
            </if>
            <if test="roam_networkType != null" >
               #{roam_networkType},
            </if>
            <if test="roam_networkStrength != null" >
               #{roam_networkStrength},
            </if>
            <if test="roam_dataConnectionStatus != null" >
               #{roam_dataConnectionStatus},
            </if>
            <if test="local_wifiPwd != null" >
               #{local_wifiPwd},
            </if>
            <if test="local_appVersionNum != null" >
               #{local_appVersionNum},
            </if>
            <if test="local_apkVersionNum != null" >
               #{local_apkVersionNum},
            </if>
            <if test="local_IMEI != null" >
               #{local_IMEI},
            </if>
            <if test="local_SN != null" >
               #{local_SN},
            </if>
            <if test="local_ICCID != null" >
               #{local_ICCID},
            </if>
            <if test="local_SIMStatus != null" >
               #{local_SIMStatus},
            </if>
            <if test="local_calibrationMark != null" >
               #{local_calibrationMark,jdbcType=VARCHAR},
            </if>
            <if test="local_networkType != null" >
               #{local_networkType},
            </if>
            <if test="local_networkStrength != null" >
               #{local_networkStrength},
            </if>
            <if test="local_dataConnectionStatus != null" >
               #{local_dataConnectionStatus},
            </if>
            <if test="local_serialComTest != null" >
               #{local_serialComTest},
            </if>
            <if test="upload_networkedTestResult != null" >
               #{upload_networkedTestResult},
            </if>
            <if test="result != null" >
               #{result},
            </if>
            <if test="creatorUserID != null" >
               #{creatorUserID},
            </if>
            <if test="creatorDate != null" >
               now(),
            </if>
            <if test="creatorUserName != null" >
               #{creatorUserName},
            </if>
            <if test="modifyUserID != null" >
               #{modifyUserID},
            </if>
            <if test="modifyDate != null" >
               #{modifyDate},
            </if>
            <if test="sysStatus != null" >
               #{sysStatus},
            </if>
            <if test="installCard != null" >
               #{installCard},
            </if>
             <if test="gps != null" >
                #{gps},
            </if>
            <if test="power != null" >
               #{power},
            </if>
        </trim>
    </insert>

    <sql id="queryFactoryPage_filter_sql">
        <if test="obj.roam_SN!=null and obj.roam_SN!=''">
            and (roam_SN like '%${obj.roam_SN}%' or local_SN like '%${obj.roam_SN}%')
        </if>
        <if test="obj.result!=null and obj.result!=''">
            and result = #{obj.result}
        </if>
        <if test="obj.begainTime != null and obj.begainTime != ''">
            <![CDATA[ and creatorDate > #{obj.begainTime} ]]>
        </if>
        <if test="obj.endTime != null and obj.endTime != ''">
            <![CDATA[ and creatorDate < #{obj.endTime} ]]>
        </if>
        <if test="obj.endTime != null and obj.endTime != ''">
            <![CDATA[ and creatorDate < #{obj.endTime} ]]>
        </if>
        <if test="obj.SSID != null and obj.SSID != ''">
            <![CDATA[ and SSID  = #{obj.SSID } ]]>
        </if>
        <if test="obj.SN != null and obj.SN != ''">
            <![CDATA[ and SN  = #{obj.SN } ]]>
        </if>
    </sql>

    <select id="getFactoryPage" resultMap="factoryTestInfoDTO" parameterType="searchDTO">
        select * from FactoryTestInfo where sysStatus = 1
        <include refid="queryFactoryPage_filter_sql"/>

        <if test="sortName!=null and sortName!=''">ORDER BY  ${sortName} </if>
        <if test="sortOrder == 'desc'"> DESC </if>
        <if test="sortOrder == 'asc'"> ASC </if>
        LIMIT #{startIndex},#{endIndex}
    </select>
	<select id="getFactoryCount" resultType="Integer" parameterType="searchDTO">
	    SELECT count(*) FROM FactoryTestInfo WHERE sysStatus=1
        <include refid="queryFactoryPage_filter_sql"/>
    </select>


    <select id="selectFactoryExport" resultMap="factoryTestInfoDTO" parameterType="factoryTestInfoDTO">
        select * from FactoryTestInfo where sysStatus = 1
        <if test="roam_SN!=null and roam_SN!=''">
            and (roam_SN like '%${roam_SN}%' or local_SN like '%${roam_SN}%')
        </if>
        <if test="result!=null and result!=''">
            and result = #{result}
        </if>
        <if test="begainTime != null and begainTime != ''">
            <![CDATA[ and creatorDate > #{begainTime} ]]>
        </if>
        <if test="endTime != null and endTime != ''">
            <![CDATA[ and creatorDate < #{endTime} ]]>
        </if>
        ORDER BY creatorDate DESC
    </select>
    <!-- 去重复查询 -->
    <select id="selectDistinctFactoryExport" resultMap="factoryTestInfoDTO" parameterType="factoryTestInfoDTO">
        select * from (
        	select * from FactoryTestInfo where sysStatus = 1
        	AND roam_ICCID!=''
			AND roam_ICCID IS NOT NULL
        <if test="roam_SN!=null and roam_SN!=''">
            and (roam_SN like '%${roam_SN}%' or local_SN like '%${roam_SN}%')
        </if>
        <if test="result!=null and result!=''">
            and result = #{result}
        </if>
        <if test="begainTime != null and begainTime != ''">
            <![CDATA[ and creatorDate > #{begainTime} ]]>
        </if>
        <if test="endTime != null and endTime != ''">
            <![CDATA[ and creatorDate < #{endTime} ]]>
        </if>
        <if test="snList != null">
        	and
        	<foreach collection="snList"  index="index" item="snItem" open="(" separator=" or " close=")">
        		(roam_SN like '%${snItem}%' or local_SN like '%${snItem}%')
        	</foreach>
        </if>
         ORDER BY creatorDate DESC
        ) c group by c.roam_SN
        ORDER BY c.roam_ICCID,c.roam_SN
    </select>

	<!-- 将设备状态改为出库 -->
	<update id="updaterepertoryStatus" parameterType="DeviceInfo">
		update DeviceInfo set repertoryStatus=#{repertoryStatus} where sysStatus=1 and SN=#{SN}
	</update>



     <select id="queryPagekeyongdevice" resultMap="DeviceInfo" parameterType="searchDTO">
		<![CDATA[
           SELECT  * FROM DeviceInfo  WHERE  sysStatus=1 AND repertoryStatus='入库' AND deviceStatus='可使用' AND distributorID IS NULL
     		]]>
		<include refid="queryPage_filter_sql_devicekeyong" />
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate DESC</if>
		LIMIT #{startIndex},#{endIndex}
	</select>

	 <select id="getcountkeyongdevice" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      		SELECT  count(*) FROM DeviceInfo  WHERE  sysStatus=1 AND repertoryStatus='入库' AND deviceStatus='可使用' AND distributorID IS NULL
      	]]>
		<include refid="queryPage_filter_sql_devicekeyong" />
	</select>
		<sql id="queryPage_filter_sql_devicekeyong">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN like '%${obj.SN}%'
      		]]>
		</if>
	</sql>

	     <select id="queryPagerukudevice" resultMap="DeviceInfo" parameterType="searchDTO">
		<![CDATA[
           SELECT  * FROM DeviceInfo  WHERE  sysStatus=1 AND repertoryStatus='出库' AND distributorID IS NULL
     		]]>
		<include refid="queryPage_filter_sql_deviceruku" />
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate DESC</if>
		LIMIT #{startIndex},#{endIndex}
	</select>

	 <select id="getcountrukudevice" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
      		SELECT  count(*) FROM DeviceInfo  WHERE  sysStatus=1 AND repertoryStatus='出库' AND distributorID IS NULL
      	]]>
		<include refid="queryPage_filter_sql_deviceruku" />
	</select>
	<sql id="queryPage_filter_sql_deviceruku">
		<if test="obj.SN != null and obj.SN != '' ">
		<![CDATA[
     			and SN like '%${obj.SN}%'
      		]]>
		</if>
	</sql>

	<update id="updateDeviceStatus_chuku" parameterType="DeviceInfo">
        update DeviceInfo set repertoryStatus='出库' where SN=#{SN}
	</update>

	<update id="updateDevice_ruku" parameterType="String">
        update DeviceInfo set repertoryStatus='入库',deviceStatus='可使用',distributorID='',distributorName='' where SN=#{SN}
	</update>

	<update id="updaterepertoryStatus2" parameterType="DeviceInfo">
	   update DeviceInfo set repertoryStatus=#{repertoryStatus} where SN=#{SN}
	</update>

    <select id="selectDeviceUpgradeExport" resultMap="DeviceUpgradingDTO" parameterType="DeviceUpgradingDTO">
        select * from DeviceUpgrading where sysStatus = 1
        <if test="SN != null and SN != '' ">
            and SN like '%${SN}%'
        </if>
        <if test="ifUpdated != null ">
            and ifUpdated = ${ifUpdated}
        </if>
        <if test="begainTime != null and begainTime != '' ">
            <![CDATA[and creatorDate >= #{begainTime} ]]>
        </if>
        <if test="endTime != null and endTime != '' ">
            <![CDATA[and creatorDate <= #{endTime} ]]>
        </if>
        <if test="creatorUserName != null and creatorUserName != '' ">
            and creatorUserName like '%${creatorUserName}%'
        </if>
        order by creatorDate desc
    </select>
	<select id="selectExcelExportDevice" parameterType="DeviceInfo" resultMap="DeviceInfo">
		SELECT * FROM DeviceInfo
		WHERE sysStatus=1
		and distributorID=${distributorID}
		<!--and deviceID in (${deviceID}) -->
		order by creatorDate DESC
	</select>
	<update id="updateVersionBySN" parameterType="DeviceInfo">
		UPDATE deviceinfo
		<set>
			<if test="firmWareVer != null and firmWareVer != '' ">
				firmWareVer=#{firmWareVer},
			</if>
			<if test="firmWareAPKVer != null and firmWareAPKVer != '' ">
				firmWareAPKVer=#{firmWareAPKVer},
			</if>
			<if test="version != null and version != '' ">
				version=#{version},
			</if>
			<if test="versionAPK != null and versionAPK != '' ">
				versionAPK=#{versionAPK},
			</if>
			<if test="1==1">
				modifyDate=now(),
			</if>
		</set> 
		WHERE SN=#{SN}
	</update>
</mapper>
