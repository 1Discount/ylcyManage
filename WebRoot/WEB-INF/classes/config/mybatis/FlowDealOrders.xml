<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.Manage.dao.FlowDealOrdersDao">

	<resultMap type="flowDealOrdersDTO" id="flowDealOrdersDTO">
	</resultMap>
	<resultMap type="simInfoDTO" id="simInfoDTO"></resultMap>
	<resultMap type="DeviceLogs" id="DeviceLogs">
	</resultMap>
	<!-- planUseDateCCount使用默认即可 -->
	<sql id="allColumn">
		flowDealID,orderID,customerID,customerName,speedStr,
		flowPlanID,flowPlanName,orderCreateDate,userCountry,panlUserDate,
		orderStatus,orderType,IfFinish,flowDays,minsRemaining,daysRemaining,
		orderAmount,flowExpireDate,SN,ifActivate,activateDate,beginDate,intradayDate,
		ifLimitSpeed,limitSpeed,limitValve,flowUsed,IMSI,lastUpdateDate,
		remark,creatorUserID,creatorUserName,journey,creatorDate,modifyUserID,modifyDate,sysStatus,flowTotal,ifVPN,refundStatus,refundAmount,orderSource
	</sql>

	<sql id="allColumnvalue">
		#{flowDealID},#{orderID},#{customerID},#{customerName},#{speedStr},
		#{flowPlanID},#{flowPlanName},#{orderCreateDate},#{userCountry},#{panlUserDate},
		#{orderStatus},#{orderType},#{IfFinish},#{flowDays},#{minsRemaining},#{daysRemaining},
		#{orderAmount},#{flowExpireDate},#{SN},#{ifActivate},#{activateDate},#{beginDate},#{intradayDate},
		#{ifLimitSpeed},#{limitSpeed},#{limitValve},#{flowUsed},#{IMSI},#{lastUpdateDate},
		#{remark},#{creatorUserID},#{creatorUserName},#{journey},now(),null,null,1,#{flowTotal},#{ifVPN},#{refundStatus},#{refundAmount},#{orderSource}
	</sql>

	<!-- 条件查询sql片段 -->
	<sql id="queryPage_filter_sql">
		<if test="obj!= null and obj.flowDealID !=null and obj.flowDealID!='' ">
		<![CDATA[
			and flowDealID like '${obj.flowDealID}%' 
		]]>
		</if>
		<if test="obj!= null and obj.customerName !=null and obj.customerName!='' ">
		<![CDATA[
			and customerName like '%${obj.customerName}%' 
		]]>
		</if>
		<if test="obj!= null and obj.flowPlanID !=null and obj.flowPlanID!='' ">
        <![CDATA[
            and flowPlanID = #{obj.flowPlanID} 
        ]]>
		</if>
		<if test="obj!= null and obj.SN !=null and obj.SN!='' ">
        <![CDATA[
            and SN like '%${obj.SN}%' 
        ]]>
		</if>
		<if test="obj!= null and obj.orderStatus !=null and obj.orderStatus!=''">
		<![CDATA[
			and orderStatus = #{obj.orderStatus} 
		]]>
		</if>
		<if test="obj!= null and obj.ifActivate !=null and obj.ifActivate!=''">
        <![CDATA[
            and ifActivate = #{obj.ifActivate} 
        ]]>
		</if>
		<if
			test="obj!= null and obj.begindateForQuery !=null  and obj.enddate!=null">
		<![CDATA[
			and creatorDate >=#{obj.begindateForQuery} and creatorDate <=#{obj.enddate} 
		]]>
		</if>
        <if test="obj.refundStatus!=null and obj.refundStatus!=''">
            <if test="obj.refundStatus=='是'.toString()">
            and refundStatus = '已退款'
            </if>
            <if test="obj.refundStatus=='否'.toString()">
            and refundStatus != '已退款'
            </if>
        </if>
		<if test="obj!= null and obj.sysStatus==true ">
		<![CDATA[
			and sysStatus = 1
		]]>
		</if>
		<if test="obj!= null and obj.userCountry!=null and obj.userCountry!=''">
        <![CDATA[
            and userCountry LIKE '%${obj.userCountry}%'
        ]]>
		</if>
		<if test="obj!= null and obj.beginDateForLastUpdateDate !=null  and obj.endDateForLastUpdateDate==null">
        <![CDATA[
            and lastUpdateDate like '%${obj.beginDateForLastUpdateDate}%'
        ]]>
		</if>
		<if test="obj!= null and obj.isUserd !=null">
        	<if test="obj.isUserd == '是'.toString()">
        		<![CDATA[
		            and (lastUpdateDate is  not null and lastUpdateDate!='')
		       	]]>
        	</if>
        	<if test="obj.isUserd == '否'.toString()">
        		<![CDATA[
		            and (lastUpdateDate is  null or lastUpdateDate='')
		       	]]>
        	</if>
		</if>
		<if test="obj!= null and obj.beginDateForLastUpdateDate !=null  and obj.endDateForLastUpdateDate!=null">
        <![CDATA[
            and lastUpdateDate >=#{obj.beginDateForLastUpdateDate}  and lastUpdateDate <=#{obj.endDateForLastUpdateDate}
        ]]>
		</if>
		<if test="obj!= null and obj.beginDateForPanlUserDate !=null  and obj.endDateForPanlUserDate!=null">
        <![CDATA[
            and panlUserDate  like '%${obj.beginDateForPanlUserDate}%'
        ]]>
		</if>
		<if test="obj!= null and obj.queryFlag == 1"> <!-- and obj.panlUserDate != null and obj.panlUserDate != '' -->
        <![CDATA[
            and (date(panlUserDate) = date(now()) or orderStatus in('可使用','使用中','已暂停'))
        ]]>
		</if>
		<!-- ahming 增加 orderID 过滤, 特殊的总订单id目前设定为 10086到10999, 注意下面 orderSource 的判断也适当增加一段来优化 -->
		<if test="obj!= null and obj.orderID !=null and obj.orderID!=''">
			<if test="obj.orderID=='special'">
            <![CDATA[
                and LENGTH(orderID)=5 and orderID like '10%'
            ]]>
			</if>
			<if test="obj.orderID!='special'">
            <![CDATA[
                and orderID = #{obj.orderID}
            ]]>
			</if>
		</if>
		<if test="obj!= null and (obj.orderID==null or obj.orderID=='') and obj.orderSource !=null  and obj.orderSource !=''">
			<if test="obj.orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="obj.orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="obj.orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="obj.orderSource=='后台'">
				and orderID NOT like '%GW%'
				and orderID NOT like '%WX%'
				and orderID NOT like '%YZ%'
				and orderID NOT like '%AP%'
			</if>
			<if test="obj.orderSource=='天猫' or obj.orderSource=='淘宝A' or obj.orderSource=='淘宝B' or obj.orderSource=='其它' or obj.orderSource=='线下'">
				<if test="obj.orderSource=='天猫'">
					and orderSource  = #{obj.orderSource}
				</if>
				<if test="obj.orderSource=='淘宝A'">
					and orderSource  = #{obj.orderSource}
				</if>
				<if test="obj.orderSource=='淘宝B'">
					and orderSource  = #{obj.orderSource}
				</if>
				<if test="obj.orderSource=='其它'">
					and orderSource  = #{obj.orderSource}
				</if>
				<if test="obj.orderSource=='线下'">
					and orderSource  = #{obj.orderSource}
				</if>
			</if>
			<if test="obj.orderSource=='APP'">
				and orderID like '%AP%'
			</if>
			<if test="obj.orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
		</if>
	</sql>

	<insert id="insertinfo" parameterType="flowDealOrdersDTO">
		insert into FlowDealOrders (
		<include refid="allColumn"></include>
		) value(
		<include refid="allColumnvalue"></include>
		)
	</insert>

	<!-- 完成订单更新 -->
	<update id="updateiffinish" parameterType="flowDealOrdersDTO">
		update FlowDealOrders
		set
		SN=#{SN},ifFinish=#{ifFinish},ifActivate=#{ifActivate},activateDate=#{activateDate},orderStatus=#{orderStatus}
		where flowDealID=#{flowDealID}
	</update>

	<!-- 删除 -->
	<update id="delfloworder" parameterType="java.lang.String">
		update FlowDealOrders set sysStatus=0 where flowDealID=#{flowDealID}
	</update>

	<!-- 根据订单ID删除 -->
	<update id="delfloworderbyoid" parameterType="java.lang.String">
		update FlowDealOrders set sysStatus=0 where orderID=#{orderID}
	</update>

	<!-- 根据订单ID查询列表 -->
	<select id="getbyoid" resultMap="flowDealOrdersDTO" parameterType="java.lang.String">
		select * from FlowDealOrders where sysStatus=1 and ifFinish='是' and orderID=#{orderID}
	</select>

	<select id="getbyid" resultMap="flowDealOrdersDTO" parameterType="java.lang.String">
		select * from FlowDealOrders where ifFinish='是' and flowDealID=#{flowDealID}
	</select>
	
	<select id="getflowDeal" resultMap="flowDealOrdersDTO" parameterType="java.lang.String">
		select * from FlowDealOrders where flowDealID=#{flowDealID}
	</select>

	<!-- 分页查询 -->
	<select id="queryPage" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		<![CDATA[
			select * from FlowDealOrders where ifFinish='是' and customerID!='10086' and sysStatus = 1
		]]>
		<include refid="queryPage_filter_sql" />
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		<if test="sortOrder == 'desc'"> DESC </if>
		<if test="sortOrder == 'asc'"> ASC </if>
		<if test="sortOrder == '' or sortOrder==null"> DESC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<!-- 查询总记录 -->
	<select id="getcount" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
		select count(*) from FlowDealOrders where ifFinish='是' and customerID!='10086' and sysStatus = 1
	]]>
		<include refid="queryPage_filter_sql" />
	</select>
	
	<select id="queryPage1" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
	<![CDATA[
		select * from FlowDealOrders where  sysStatus = 1 and orderStatus in('使用中','可使用')  and lastUpdateDate like concat('%',date(now()),'%')
	]]>
	<include refid="queryPage_filter_sql" />
		order by
	<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
	<if test="sortName!=null and sortName!=''">${sortName}</if>
	<if test="sortOrder == 'desc'"> DESC </if>
	<if test="sortOrder == 'asc'"> ASC </if>
	<if test="sortOrder == '' or sortOrder==null"> DESC </if>
	LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getcount1" resultType="Integer" parameterType="searchDTO">
	<![CDATA[
		select count(*) from FlowDealOrders where  sysStatus = 1 and orderStatus in('使用中','可使用')
	]]>
		<include refid="queryPage_filter_sql" />
	</select>


	<!-- 数据交易列表数据导出 -->
	<select id="queryPageExcel" resultMap="flowDealOrdersDTO" parameterType="flowDealOrdersDTO">
		<![CDATA[
			select * from FlowDealOrders where ifFinish='是' and customerID!='10086' and sysStatus = 1
		]]>
		<if test="isUserd != null and isUserd!='' ">
			<if test="isUserd == '是'.toString()">
        		<![CDATA[
		            and (lastUpdateDate is  not null and lastUpdateDate!='')
		       	]]>
        	</if>
        	<if test="isUserd == '否'.toString()">
        		<![CDATA[
		            and (lastUpdateDate is  null or lastUpdateDate='')
		       	]]>
        	</if>
		</if>
		
		<if test="userCountry!= null and userCountry!='' ">
        <![CDATA[
            and userCountry like '%${userCountry}%'
        ]]>
		</if>
		<if test="flowDealID!= null and flowDealID!='' ">
        <![CDATA[
            and flowDealID like '%${flowDealID}%'
        ]]>
		</if>
		<if test="customerName!= null and customerName!='' ">
        <![CDATA[
            and customerName like '%${customerName}%'
        ]]>
		</if>
		<if test="SN!= null and SN!='' ">
        <![CDATA[
            and SN like '%${SN}%'
        ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!='' ">
        <![CDATA[
            and orderStatus = #{orderStatus}
        ]]>
		</if>
		<if test="orderSource!= null  and orderSource !=''">
			<if test="orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%'
			</if>
			<if test="orderSource=='APP'">
				and orderID like '%AP%'
			</if>
		</if>
		<if test="begindateForQuery !=null and begindateForQuery!=''  and enddate!=null  and enddate!=''">
			<![CDATA[
				and creatorDate >=#{begindateForQuery} and creatorDate <=#{enddate}
			]]>
		</if>
		order by creatorDate
	</select>
	
	<!-- 编辑保存 -->
	<update id="editsave" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set
		ifVPN=#{ifVPN},journey=#{journey},modifyDate=now(),modifyUserID=#{modifyUserID},panlUserDate=#{panlUserDate},flowExpireDate=#{flowExpireDate},
		userCountry=#{userCountry},flowDays=#{flowDays},daysRemaining=#{daysRemaining},remark=#{remark},orderAmount=#{orderAmount},
		speedStr=#{speedStr},orderType=#{orderType},flowTotal=#{flowTotal} where flowDealID=#{flowDealID}
	</update>

	<!-- 编辑保存 -->
	<update id="editsaveauto" parameterType="flowDealOrdersDTO" >
	    update FlowDealOrders
	    <set >
	      <if test="userCountry != null" >
	           userCountry = #{userCountry},
	       </if>
	      <if test="daysRemaining != 0" >
	           daysRemaining = #{daysRemaining},
	       </if>
	      <if test="ifVPN != null" >
	           ifVPN = #{ifVPN},
	       </if>
	      <if test="flowDays != null" >
	           flowDays = #{flowDays},
	       </if>
	      <if test="journey != null" >
	           journey = #{journey},
	       </if>
	      <if test="speedStr != null" >
	           speedStr = #{speedStr},
	       </if>
	      <if test="panlUserDate != null" >
	           panlUserDate = #{panlUserDate},
	       </if>
	      <if test="flowExpireDate != null" >
	           flowExpireDate = #{flowExpireDate},
	       </if>
	      <if test="remark != null" >
	           remark = #{remark}
	       </if>
	    </set>
	    where flowDealID = #{flowDealID}
	</update>
	
	

	<!-- 激活 -->
	<update id="activate" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set ifActivate='是' ,activateDate=now()
		,orderStatus='可使用'
		<if test="SN !=null and SN !=''">
			,SN=#{SN}
		</if>
		where 1=1
		<if test="flowDealID!=null and flowDealID !=''">
			and flowDealID=#{flowDealID}
		</if>
		<if test="orderID!=null and orderID!=''">
			and orderID=#{orderID}
		</if>
	</update>
	
	<!-- 暂停服务 -->
	<update id="pause" parameterType="String">
		update FlowDealOrders set orderStatus='已暂停',modifyDate=now() where flowDealID=#{flowDealID}
	</update>

	<!--启动服务 -->
	<update id="launch" parameterType="String">
		update FlowDealOrders set orderStatus='使用中',modifyDate=now() where flowDealID=#{flowDealID}
	</update>

	<!-- 限速 -->
	<update id="limitSpeed" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set limitSpeed=#{limitSpeed},ifLimitSpeed=#{ifLimitSpeed},modifyDate=now() where flowDealID=#{flowDealID}
	</update>

	<!-- 更新可用国家列表 -->
	<update id="updateCountry" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set userCountry=#{userCountry},modifyDate=now() where flowDealID=#{flowDealID}
	</update>

	<!-- 根据客户ID查询 -->
	<select id="getFlowDealOrdersForCustomerID" resultMap="flowDealOrdersDTO" parameterType="java.lang.String">
		select * from FlowDealOrders where sysStatus=1 and ifFinish='是' and customerID=#{customerID}
	</select>

<!-- ******************流量订单统计 begin****************** -->
	<!-- 流量订单统计 --> 
	<select id="statistics1" resultType="map" parameterType="flowDealOrdersDTO">
		SELECT (SELECT COUNT(*) FROM FlowDealOrders where customerID!='10086'
		<include refid="countsqlbaobiao" />
		) as notdelete,
		(SELECT count(*) FROM FlowDealOrders WHERE beginDate != '' and
		customerID!='10086'
		<include refid="countsqlbaobiao" />
		) as usered,
		(SELECT count(*) FROM FlowDealOrders WHERE ISNULL(beginDate) and
		customerID!='10086'
		<include refid="countsqlbaobiao" />
		) as notuser,
		(SELECT SUM(orderAmount) FROM FlowDealOrders WHERE customerID!='10086'
		<include refid="countsqlbaobiao" />
		) as amount,
		(select COUNT(*) from FlowDealOrders where sysStatus = 1 
		 and orderID NOT LIKE '%AP%' and orderID NOT LIKE '%GW%' and orderID !='10086' 
		 <![CDATA[
		 	and panlUserDate<='${enddate} 23:59:59' and flowExpireDate>'${begindateForQuery} 00:00:00'
		 ]]>
		<if test=" orderStatus !=null and orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{orderStatus}
		]]>
		</if>
		<if test="orderSource !=null  and orderSource !=''">
			<if test="orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
			<if test="orderSource=='APP'">
				and orderID like '%AP%'
			</if>
		</if>
		<if test="customerName !=null  and customerName!=''">
		<![CDATA[
			and customerName =#{customerName}
		]]>
		</if>
		<if test="userCountry !=null  and userCountry!=''">
		<![CDATA[
			and userCountry like '%${userCountry}%'
		]]>
		</if>
		<if test="isUserd !=null  and isUserd!=''">
		<![CDATA[
			and lastTime like is not null and lastTime !=''
		]]>
		</if>
		) as available
		FROM FlowDealOrders where 1=1
		LIMIT 1
	</select>

	<select id="getnotdelete" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		SELECT * FROM FlowDealOrders where customerID!='10086'
		<include refid="countsqlObj" />
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getusered" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		SELECT * FROM FlowDealOrders WHERE beginDate != '' and
		customerID!='10086'
		<include refid="countsqlObj" />
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getnotuser" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		SELECT * FROM FlowDealOrders WHERE ISNULL(beginDate) and
		customerID!='10086'
		<include refid="countsqlObj" />
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getamount" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		SELECT * FROM FlowDealOrders WHERE customerID!='10086'
		<include refid="countsqlObj" />
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getavailable" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		select  * from FlowDealOrders where sysStatus = 1 
		and orderID NOT LIKE '%AP%' and orderID NOT LIKE '%GW%' and orderID !='10086' 
		 <![CDATA[
		 	and panlUserDate<='${obj.enddate} 23:59:59' and flowExpireDate>'${obj.begindateForQuery} 00:00:00'
		 ]]>
		<if test=" obj.orderStatus !=null and obj.orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{obj.orderStatus}
		]]>
		</if>
		<if test="obj.orderSource !=null  and obj.orderSource !=''">
			<if test="obj.orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="obj.orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="obj.orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="obj.orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="obj.orderSource=='APP'">
				and orderID like '%AP%'
			</if>
			<if test="obj.orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
		</if>
		<if test="obj.customerName !=null  and obj.customerName!=''">
		<![CDATA[
			and customerName =#{obj.customerName}
		]]>
		</if>
		<if test="obj.userCountry !=null  and obj.userCountry!=''">
		<![CDATA[
			and userCountry like '%${obj.userCountry}%'
		]]>
		</if>
		<if test="obj.isUserd !=null  and obj.isUserd!=''">
		<![CDATA[
			and lastTime like is not null and lastTime !=''
		]]>
		</if>
			order by creatorDate
			LIMIT #{startIndex},#{endIndex}
	</select>

	<select id="getnotdeleteCount" resultType="Integer" parameterType="searchDTO">
		SELECT COUNT(*) FROM FlowDealOrders where customerID!='10086'
		<include refid="countsqlObj" />
	</select>
	
	<select id="getuseredCount" resultType="Integer" parameterType="searchDTO">
		SELECT count(*) FROM FlowDealOrders WHERE beginDate != '' and
		customerID!='10086'
		<include refid="countsqlObj" />
	</select>
	
	<select id="getnotuserCount" resultType="Integer" parameterType="searchDTO">
		SELECT count(*) FROM FlowDealOrders WHERE ISNULL(beginDate) and customerID!='10086'
		<include refid="countsqlObj" />
	</select>
	
	<select id="getamountCount" resultType="Integer" parameterType="searchDTO">
		SELECT count(*) FROM FlowDealOrders WHERE customerID!='10086'
		<include refid="countsqlObj" />
	</select>
	
	<select id="getavailableCount" resultType="Integer" parameterType="searchDTO">
		select COUNT(*) from FlowDealOrders where sysStatus = 1 
		 and orderID NOT LIKE '%AP%' and orderID NOT LIKE '%GW%' and orderID !='10086' 
		 <![CDATA[
		 	and panlUserDate<='${obj.enddate} 23:59:59' and flowExpireDate>'${obj.begindateForQuery} 00:00:00'
		 ]]>
		<if test=" obj.orderStatus !=null and obj.orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{obj.orderStatus}
		]]>
		</if>
		<if test="obj.orderSource !=null  and obj.orderSource !=''">
			<if test="obj.orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="obj.orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="obj.orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="obj.orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="obj.orderSource=='APP'">
				and orderID like '%AP%'
			</if>
			<if test="obj.orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
		</if>
		<if test="obj.customerName !=null  and obj.customerName!=''">
		<![CDATA[
			and customerName =#{obj.customerName}
		]]>
		</if>
		<if test="obj.userCountry !=null  and obj.userCountry!=''">
		<![CDATA[
			and userCountry like '%${obj.userCountry}%'
		]]>
		</if>
		<if test="obj.isUserd !=null  and obj.isUserd!=''">
		<![CDATA[
			and lastTime like is not null and lastTime !=''
		]]>
		</if>
	</select>


	<sql id="countsqlbaobiao">
		<if test="flowDealID !=null and flowDealID!='' ">
		<![CDATA[
			and flowDealID like 'QD${flowDealID}%'
		]]>
		</if>
		<if test=" orderStatus !=null and orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{orderStatus}
		]]>
		</if>
		<if test="orderSource !=null  and orderSource !=''">
			<if test="orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
			<if test="orderSource=='APP'">
				and orderID like '%AP%'
			</if>
		</if>
		<if test="begindateForQuery !=null  and enddate!=null">
		 <![CDATA[
		 	and panlUserDate<='${enddate} 23:59:59' and flowExpireDate>'${begindateForQuery} 00:00:00'
		 ]]>
		</if>
		<if test="customerName !=null  and customerName!=''">
		<![CDATA[
			and customerName =#{customerName}
		]]>
		</if>
		<if test="userCountry !=null  and userCountry!=''">
		<![CDATA[
			and userCountry like '%${userCountry}%'
		]]>
		</if>
		<if test="isUserd !=null  and isUserd!=''">
		<![CDATA[
			and lastTime like is not null and lastTime !=''
		]]>
		</if>
	</sql>
	
	<sql id="countsqlObj">
		<if test="obj!=null and obj.flowDealID !=null and obj.flowDealID!='' ">
		<![CDATA[
			and flowDealID like 'QD${obj.flowDealID}%'
		]]>
		</if>
		<if test="obj.orderStatus !=null and obj.orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{obj.orderStatus}
		]]>
		</if>
		<if test="obj!=null and obj.orderSource !=null  and obj.orderSource !=''">
			<if test="obj.orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="obj.orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="obj.orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="obj.orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="obj.orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
			<if test="obj.orderSource=='APP'">
				and orderID like '%AP%'
			</if>
		</if>
		<if test="obj.begindateForQuery !=null  and obj.begindateForQuery !='' and obj.enddate!=null and obj.enddate!=''">
		<![CDATA[
			and panlUserDate<='${obj.enddate} 23:59:59' and flowExpireDate>'${obj.begindateForQuery} 00:00:00'
		]]>
		</if>
		<if test="obj.customerName !=null  and obj.customerName!=''">
		<![CDATA[
			and customerName =#{obj.customerName}
		]]>
		</if>
		<if test="obj.userCountry !=null  and obj.userCountry!=''">
		<![CDATA[
			and userCountry LIKE '%${obj.userCountry}%'
		]]>
		</if>
	</sql>
	<!-- ******************流量订单统计 end****************** -->

	<!-- ******************首页条形统计图 begin****************** -->
	<select id="statistics" resultType="map" parameterType="flowDealOrdersDTO">
		SELECT
		(SELECT COUNT(*) FROM FlowDealOrders where customerID!='10086'
		<include refid="countsql" />
		) as count,
		(SELECT COUNT(*) FROM FlowDealOrders where ifFinish='是' and
		sysStatus=1 and customerID!='10086'
		<include refid="countsql" />
		) as efficient,
		(SELECT COUNT(*) FROM FlowDealOrders where ifFinish='是'
		and sysStatus=1 and ifActivate='是' and customerID!='10086'
		<include refid="countsql" />
		) as activate,
		(SELECT COUNT(*) FROM FlowDealOrders where ifFinish='是'
		and sysStatus=1 and ifActivate='否' and customerID!='10086'
		<include refid="countsql" />
		) as unactivate,
		(SELECT COUNT(*) FROM FlowDealOrders where
		ifFinish='否' and sysStatus=1 and customerID!='10086'
		<include refid="countsql" />
		) as unfinished,
		(SELECT COUNT(*) FROM FlowDealOrders where sysStatus=0
		and customerID!='10086'
		<include refid="countsql" />
		) as delcount,
		(SELECT SUM(orderAmount) FROM FlowDealOrders where
		ifFinish='是' and sysStatus=1 and customerID!='10086'
		<include refid="countsql" />
		) as amount
		FROM FlowDealOrders where 1=1
		LIMIT 1
	</select>

	<sql id="countsql">
		<if test="flowDealID !=null and flowDealID!='' ">
		<![CDATA[
			and flowDealID like 'QD${flowDealID}%'
		]]>
		</if>
		<if test=" orderStatus !=null and orderStatus!='' ">
		<![CDATA[
			and orderStatus = #{orderStatus}
		]]>
		</if>
		<if test="orderSource !=null  and orderSource !=''">
			<if test="orderSource=='官网'">
				and orderID like '%GW%'
			</if>
			<if test="orderSource=='渠道商'">
				and orderID like '%QD%'
			</if>
			<if test="orderSource=='微信'">
				and orderID like '%WX%'
			</if>
			<if test="orderSource=='有赞'">
				and orderID like '%YZ%'
			</if>
			<if test="orderSource=='后台'">
				and orderID NOT like '%GW%' and orderID NOT like '%WX%' and orderID NOT like '%YZ%' and orderID NOT like '%AP%' and orderID NOT like '%QD%'
			</if>
			<if test="orderSource=='APP'">
				and orderID like '%AP%'
			</if>
		</if>
		<if test="begindateForQuery !=null  and enddate!=null">
		<![CDATA[
			and creatorDate >=#{begindateForQuery} and creatorDate <=#{enddate}
		]]>
		</if>
		<if test="customerName !=null  and customerName!=''">
		<![CDATA[
			and customerName =#{customerName}
		]]>
		</if>
		<if test="userCountry !=null  and userCountry!=''">
		<![CDATA[
			and userCountry like '%${userCountry}%'
		]]>
		</if>
	</sql>
	<!-- ******************首页条形统计图 end****************** -->

	<!-- SOCKET部分 -->
	<!-- 设备接入认证 -->
	<select id="getorderbysn" resultType="flowDealOrdersDTO" parameterType="flowDealOrdersDTO">
		select * from FlowDealOrders where SN=#{SN} and sysStatus=1 and orderStatus in(#{orderStatus}) and ifActivate ='是'
	</select>

	<!-- 更新订单表字段 -->
	<update id="updateorder" parameterType="flowDealOrdersDTO">
			update FlowDealOrders set flowDealID=#{flowDealID}
		<if test="daysRemaining!=null and daysRemaining!=''">
			,daysRemaining=#{daysRemaining}
		</if>
		<if test="minsRemaining!=null and minsRemaining!=''">
			,minsRemaining=#{minsRemaining}
		</if>
		<if test="flowUsed!=null and flowUsed!=''">
			,flowUsed=#{flowUsed}
		</if>
		<if test="IMSI!=null and IMSI!=''">
			,IMSI=#{IMSI}
		</if>
		<if test="intradayDate!=null and intradayDate!=''">
			,intradayDate=#{intradayDate}
		</if>
		<if test="beginDate!=null and beginDate!=''">
			,beginDate=#{beginDate}
		</if>
		<if test="lastUpdateDate!=null and lastUpdateDate!=''">
			,lastUpdateDate=#{lastUpdateDate}
		</if>
			where flowDealID=#{flowDealID}

	</update>

	<select id="queryPageAvailableOrder" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
        <![CDATA[
             select t1.* from FlowDealOrders as t1  where   t1.sysStatus = 1 and t1.orderStatus in('使用中','可使用')
				and  unix_timestamp(flowExpireDate)>unix_timestamp(concat(date(now()),' 00:00:00'))
				and unix_timestamp(panlUserDate)<=unix_timestamp(concat(date(now()),' 23:59:00')) and customerID!='10086'
        ]]>

		<if test="obj!= null and obj.customerName !=null and obj.customerName!='' ">

		<![CDATA[
			and t1.customerName like '%${obj.customerName}%'
		]]>
		</if>
		<if test="obj!= null and obj.userCountry!=null and obj.userCountry!=''">
        <![CDATA[
            and t1.userCountry LIKE '%${obj.userCountry}%'
        ]]>
		</if>
		<if test="obj!= null and obj.SN !=null and obj.SN!='' ">
        <![CDATA[
            and t1.SN LIKE '%${obj.SN}%'
        ]]>
		</if>
		and (date(panlUserDate) = date(now()) or t1.orderStatus
		in('使用中','已暂停'))
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		<if test="sortOrder == 'desc'"> DESC </if>
		<if test="sortOrder == 'asc'"> ASC </if>
		<if test="sortOrder == '' or sortOrder==null"> DESC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<!-- 查询总记录 今天可用订单 -->
	<select id="getcount_join" resultType="Integer" parameterType="searchDTO">
     	<![CDATA[
             select COUNT(t1.orderID) from FlowDealOrders as t1  where   t1.sysStatus = 1 and t1.orderStatus in('使用中','可使用')
				and  unix_timestamp(flowExpireDate)>unix_timestamp(concat(date(now()),' 00:00:00'))
				and unix_timestamp(panlUserDate)<=unix_timestamp(concat(date(now()),' 23:59:00')) and customerID!='10086'
        ]]>
		<if test="obj!= null and obj.customerName !=null and obj.customerName!='' ">

		<![CDATA[
			and t1.customerName like '%${obj.customerName}%'
		]]>
		</if>
		<if test="obj!= null and obj.userCountry!=null and obj.userCountry!=''">
        <![CDATA[
            and t1.userCountry LIKE '%${obj.userCountry}%'
        ]]>
		</if>
		<if test="obj!= null and obj.SN !=null and obj.SN!='' ">
        <![CDATA[
            and t1.SN LIKE '%${obj.SN}%'
        ]]>
		</if>
	</select>


	<select id="queryPageimsi" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		<![CDATA[
			SELECT * FROM FlowDealOrders where 1=1 and IMSI=#{obj.IMSI}
		]]>
		order by creatorDate DESC LIMIT #{startIndex},#{endIndex}
	</select>
	
	<select id="getcountimsi" resultType="Integer" parameterType="searchDTO">
		<![CDATA[
			select count(*) from FlowDealOrders where 1=1 and IMSI=#{obj.IMSI}
		]]>
	</select>

	<update id="updateOrderStatusForSn" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set orderStatus=#{orderStatus},modifyDate=#{modifyDate},modifyUserID=#{modifyUserID} where SN=#{SN} and sysStatus=1
	</update>

	<!-- 设备归还将对应的流量订单改为不可用. -->
	<update id="updatebysn" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set orderStatus=#{orderStatus} where sysStatus=1 and SN=#{SN} and ifFinish='是' and ifActivate ='是' and orderStatus in('可使用','使用中','已暂停')
	</update>

	<select id="getbysn" resultMap="flowDealOrdersDTO" parameterType="String">
		select * from FlowDealOrders where SN=#{SN} and sysStatus=1 and orderStatus in('可使用','使用中','已过期') order by lastUpdateDate desc limit 1
	</select>
	
	<!-- 修改流量订单为激活状态 -->
	<update id="updateflowdeal" parameterType="java.util.Map">
		update FlowDealOrders set SN = #{SN},ifActivate='是',orderStatus ='可使用' where orderID=#{orderID}
	</update>
	
	<update id="updateflowdeal3" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set SN = #{SN},ifActivate='是',orderStatus ='可使用' where flowDealID=#{flowDealID}
	</update>
	
	<select id="selectCountbysn" parameterType="flowDealOrdersDTO"
		resultMap="flowDealOrdersDTO">
		select * from FlowDealOrders where 1=1
		<if test="sysStatus!= null and sysStatus==true ">
		<![CDATA[
			and sysStatus = 1
		]]>
		</if>
		<if test="IfFinish!= null and IfFinish!='' ">
        <![CDATA[
           	and IfFinish = #{IfFinish}
        ]]>
		</if>
		<if test="SN!= null and SN !=null and SN!='' ">
        <![CDATA[
            and SN =#{SN}
        ]]>
		</if>
		order by creatorDate desc limit 1
	</select>
	
	<update id="updateFlowdealByflowDealID" parameterType="flowDealOrdersDTO">
		<![CDATA[
			update FlowDealOrders set factoryFlag=1,serverInfo=#{serverInfo} where flowDealID=#{flowDealID}
		]]>
	</update>
	
	<update id="updateSN" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set sn=#{SN}, modifyUserID=#{modifyUserID},modifyDate=now() where flowDealID=#{flowDealID} and sysStatus=1
	</update>

	<update id="updateTestOrder">
		update FlowDealOrders set sysStatus=0 where orderID='10086' and customerID='10086' and sysStatus=1
	</update>


	<select id="getTestBySN" resultMap="flowDealOrdersDTO"
		parameterType="String">
		select * from FlowDealOrders where SN=#{SN} and customerID='10086' and
		flowExpireDate>now() and sysStatus=1 order by creatorDate limit 1
	</select>

	<!-- 按国家获取流量订单的个数 -->
	<select id="getflowdealbycountry" resultMap="flowDealOrdersDTO" parameterType="flowDealOrdersDTO">
		select journey,SN,userCountry,orderType,flowExpireDate from FlowDealOrders where sysStatus = 1 and orderStatus
		in("使用中","可使用") and orderID NOT LIKE '%AP%' and orderID NOT LIKE '%GW%' and orderID !='10086'
		<if test="panlUserDate!=null and panlUserDate!=''">
			<![CDATA[
				and  unix_timestamp(flowExpireDate)>unix_timestamp('${panlUserDate} 00:00:00')
				and unix_timestamp(panlUserDate)<=unix_timestamp('${panlUserDate} 23:59:59')
			]]>
		</if>
		and userCountry like '%${userCountry}%'
	</select>
	
	<select id="getflowdealbycountry1" resultMap="flowDealOrdersDTO" parameterType="flowDealOrdersDTO">
		select SN from FlowDealOrders where sysStatus = 1 and orderStatus
		in("使用中","可使用")
		<if test="panlUserDate!=null and panlUserDate!=''">
			<![CDATA[
				and  unix_timestamp(flowExpireDate)>unix_timestamp('${flowExpireDate}')
				and unix_timestamp(panlUserDate)<=unix_timestamp('${panlUserDate}')
			]]>
		</if>
		and userCountry like '%${userCountry}%'
	</select>
	
	<select id="beika" parameterType="java.util.HashMap" resultType="java.util.Map"
		statementType="CALLABLE">
		<![CDATA[
    		{call proc_beika(
    			#{cName,mode=IN,jdbcType=VARCHAR},
    			#{datetime,mode=IN,jdbcType=INTEGER},
    			#{short,mode=IN,jdbcType=VARCHAR}
    		)}
		]]>
	</select>
	
	<select id="getVailable" parameterType="java.util.HashMap"
		resultType="java.util.Map" statementType="CALLABLE">
		<![CDATA[
    		{call proc_vailableorder(
    			#{cName,mode=IN,jdbcType=VARCHAR},
    			#{begintime,mode=IN,jdbcType=INTEGER},
    			#{endtime,mode=IN,jdbcType=INTEGER}
    		)}
		]]>
	</select>
	
	<select id="getsimTotalandorderTotal" parameterType="java.util.HashMap" resultType="java.util.Map" statementType="CALLABLE">
		<![CDATA[
    		{call pro_floworderalwayuserinfo(
    			#{countryName,mode=IN,jdbcType=VARCHAR},
    			#{countryCode,mode=IN,jdbcType=VARCHAR},
    			#{startDate,mode=IN,jdbcType=VARCHAR},
    			#{endDate,mode=IN,jdbcType=VARCHAR}
    		)}
		]]>
	</select>
	
	<!-- 查询今天可以使用，但没有使用的流量订单 -->
	<select id="selectnotuser" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
		select t1.* from FlowDealOrders as t1 where t1.sysStatus = 1 and t1.orderStatus in("使用中","可使用")
		<if test="obj!=null and obj.panlUserDate!=null and obj.panlUserDate!='' ">
			<![CDATA[
				and  unix_timestamp(flowExpireDate)>unix_timestamp('${obj.panlUserDate} 00:00:00')
				and unix_timestamp(panlUserDate)<=unix_timestamp('${obj.panlUserDate} 23:59:00')
				and (lastUpdateDate not LIKE '%${obj.panlUserDate}%' or isnull(lastUpdateDate))
			]]>
		</if>
		<if test="obj!=null and obj.userCountry!=null and obj.userCountry!='' ">
			and (
			<foreach collection="obj.countryArray" item="plid" separator="OR">
				t1.userCountry like '%${plid}%'
			</foreach>
			)
		</if>
		<if test="obj!=null and obj.customerName!=null and obj.customerName!='' ">
			and t1.customerName like '%${obj.customerName}%'
		</if>
		<if test="obj!=null and obj.SN!=null and obj.SN!='' ">
			and t1.SN like '%${obj.SN}%'
		</if>
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<!-- 查询今天可以使用，但没有使用的流量订单总行数 -->
	<select id="selectnotuserCount" resultType="Integer" parameterType="searchDTO">
		select count(t1.flowDealID) from FlowDealOrders as t1 where
		t1.sysStatus = 1 and t1.orderStatus in("使用中","可使用")
		<if test="obj!=null and obj.panlUserDate!=null and obj.panlUserDate!='' ">
			<![CDATA[
				and  unix_timestamp(flowExpireDate)>unix_timestamp('${obj.panlUserDate} 00:00:00')
				and unix_timestamp(panlUserDate)<=unix_timestamp('${obj.panlUserDate} 23:59:00')
				and (lastUpdateDate not LIKE '%${obj.panlUserDate}%' or isnull(lastUpdateDate))
			]]>
		</if>
		<if test="obj!=null and obj.userCountry!=null and obj.userCountry!='' ">
			and (
			<foreach collection="obj.countryArray" item="plid" separator="OR">
				t1.userCountry like '%${plid}%'
			</foreach>
			)
		</if>
		<if test="obj!=null and obj.customerName!=null and obj.customerName!='' ">
			and t1.customerName like '%${obj.customerName}%'
		</if>
		<if test="obj!=null and obj.SN!=null and obj.SN!='' ">
			and t1.SN like '%${obj.SN}%'
		</if>
	</select>

	<!-- 退订时,更改总订单其下的流量订单为不可用 -->
	<update id="updateFlowOrderUnavailable" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set
		orderStatus='不可用',modifyDate=#{modifyDate},modifyUserID=#{modifyUserID}
		where orderID=#{orderID}
	</update>

	<update id="updatewxStatusFlow" parameterType="flowDealOrdersDTO">
		update
		FlowDealOrders set
		orderStatus='可使用',modifyDate=now(),modifyUserID=#{modifyUserID} where
		orderID=#{orderID}
	</update>

	<select id="selectwxOrderSnList" parameterType="String"
		resultMap="flowDealOrdersDTO">
		select * from FlowDealOrders where orderID=#{orderID} and sysStatus=1
	</select>

	<select id="getCheckSNisLiuLiang" resultType="Integer"
		parameterType="String">
		SELECT COUNT(*) FROM FlowDealOrders WHERE SN=#{SN} AND orderStatus
		in('使用中','可使用') AND sysStatus=1 ORDER BY creatorDate DESC LIMIT 1
	</select>

	<select id="getcheckordertimeagain" resultType="Integer"
		parameterType="flowDealOrdersDTO">
		SELECT COUNT(*) FROM FlowDealOrders WHERE SN=#{SN} AND sysStatus=1 AND
		flowExpireDate &lt; #{panlUserDate}
		ORDER BY flowExpireDate DESC LIMIT 1
	</select>

	<select id="getPanlUserDateFororderid" resultType="String"
		parameterType="String">
		SELECT panlUserDate FROM FlowDealOrders WHERE orderID=#{orderID} limit 1
	</select>

	<select id="getCountryisTwo">
		SELECT count(*) FROM FlowDealOrders WHERE SN=#{SN} AND orderStatus
		IN('使用中','可使用') AND userCountry LIKE '%${userCountry}%'
	</select>

	<select id="getFlowData" resultMap="flowDealOrdersDTO"
		parameterType="String">
		select * from FlowDealOrders where orderID=#{orderID} and sysStatus=1 limit
		1
	</select>

	<select id="checkCustomerEqual" parameterType="flowDealOrdersDTO"
		resultType="Integer">
		SELECT count(*) FROM FlowDealOrders WHERE SN=#{SN} AND
		creatorUserID=#{creatorUserID} AND sysStatus=1
		AND orderStatus IN ('可使用','使用中')
	</select>

	<select id="getuserCountry" resultType="String" parameterType="String">
		select userCountry from FlowDealOrders where orderID=#{orderID} and
		sysStatus=1 limit 1
	</select>

	<!-- 取消标3星且全部未发货的总订单, 和其他的流量订单/设备订单设置为不可用 -->
	<update id="cancelYouzanStar3FlowOrder" parameterType="OrdersInfo">
        <![CDATA[
            UPDATE FlowDealOrders SET orderStatus='不可用',modifyDate=now(),modifyUserID=#{modifyUserID} WHERE 1=1
        ]]>
		AND orderID LIKE '${orderID}%'
	</update>


	<select id="getIsFlowUseOrderForSn" resultType="Integer"
		parameterType="String">
        <![CDATA[
        select count(*) from FlowDealOrders where SN=#{SN} and orderStatus in('使用中','可使用')
        and sysStatus=1 AND creatorUserID!='10086'
        ]]>
	</select>

	<select id="getIsFlowUseOrderForSnqds" resultType="Integer"
		parameterType="flowDealOrdersDTO">
        <![CDATA[
        select count(*) from FlowDealOrders where SN=#{SN} and orderStatus='使用中'
        and sysStatus=1 and creatorUserID=#{creatorUserID}
        ]]>
	</select>
	
	<!-- 暂停 所有使用中的订单 （渠道商暂停订单接口） -->
	<update id="pauseOrders" parameterType="flowDealOrdersDTO">
		UPDATE FlowDealOrders SET
		orderStatus='已暂停',modifyDate=now(),modifyUserID=#{modifyUserID} where
		SN=#{SN} AND orderStatus='使用中'
	</update>

	<!-- 暂停最近使用的订单 -->
	<update id="pauseOrdersOne" parameterType="flowDealOrdersDTO">
		UPDATE FlowDealOrders SET
		orderStatus='已暂停',modifyDate=now(),modifyUserID=#{modifyUserID} where
		SN=#{SN} AND orderStatus='使用中' ORDER BY flowExpireDate DESC LIMIT 1
	</update>
	
	<!-- 根据渠道商查询未使用订单   按SN-->
	<select id="queryPageDis" parameterType="searchDTO" resultMap="flowDealOrdersDTO">
		select *,count(distinct SN) from FlowDealOrders where sysStatus=1 
		<if test="obj.lastUpdateDate !=null  and obj.lastUpdateDate!=''">
		 <![CDATA[
		 	and (lastUpdateDate is NOT null and lastUpdateDate!='')
		 ]]>
		</if>
		<if test="obj.lastUpdateDate ==null">
		 <![CDATA[
		 	and (lastUpdateDate is  null or lastUpdateDate='')
		 ]]>
		</if>
	 	<if test="obj.flowDealID !=null  and obj.flowDealID!=''">
		 <![CDATA[
		 and flowDealID like '${obj.flowDealID}%' 
		 ]]>
		</if>
		<if test="obj.SN !=null  and obj.SN !=''">
		 <![CDATA[
		 and SN  LIKE '%${obj.SN}%' 
		]]>
		</if>
		<if test="obj.SN ==null  or obj.SN ==''">
		 <![CDATA[
		 and SN  is not null
		]]>
		</if>
		<if test="obj.begindateForQuery !=null and obj.begindateForQuery !=''  and obj.enddate!=null and obj.enddate!=''">
		<![CDATA[
			and creatorDate >=#{obj.begindateForQuery} and creatorDate <=#{obj.enddate} 
		]]>
		</if>
		GROUP BY SN
		order by
		<if test="sortName == 'creatorDate' or sortName == '' or sortName == null"> creatorDate </if>
		<if test="sortName!=null and sortName!=''">${sortName}</if>
		<if test="sortOrder == 'desc'"> DESC </if>
		<if test="sortOrder == 'asc'"> ASC </if>
		<if test="sortOrder == '' or sortOrder==null"> DESC </if>
		LIMIT #{startIndex},#{endIndex}
	</select>
	
	<!-- 根据渠道商查询未使用订单行数 按SN-->
	<select id="queryPageDisCount"  parameterType="searchDTO" resultType="Integer" >
		select count(distinct sn) from FlowDealOrders where sysStatus=1 
		<!-- 使用订单 -->
		<if test="obj.lastUpdateDate !=null  and obj.lastUpdateDate!=''">
		 <![CDATA[
		 	and (lastUpdateDate is NOT null and lastUpdateDate!='')
		 ]]>
		</if>
		<!-- 未使用订单 -->
		<if test="obj.lastUpdateDate ==null">
		 <![CDATA[
		 	and (lastUpdateDate is  null or lastUpdateDate='') 
		 ]]>
		</if>
	    <if test="obj.flowDealID !=null  and obj.flowDealID!=''">
		 <![CDATA[
		 and flowDealID like '${obj.flowDealID}%' 
		 ]]>
		</if>
		<if test="obj.SN !=null  and obj.SN !=''">
		 <![CDATA[
		 and SN  LIKE '%${obj.SN}%' 
		]]>
		</if>
		<if test="obj.SN ==null  or obj.SN ==''">
		 <![CDATA[
		 and SN  is not null 
		]]>
		</if>
		<if test="obj.begindateForQuery !=null and obj.begindateForQuery !=''  and obj.enddate!=null and obj.enddate!=''">
		<![CDATA[
			and creatorDate >=#{obj.begindateForQuery} and creatorDate <=#{obj.enddate}
		]]>
		</if>
	</select>
	
	<select id="getuseredflowdealbydis" parameterType="flowDealOrdersDTO" resultMap="flowDealOrdersDTO"> 
		select  *,count(distinct SN)  from FlowDealOrders where sysStatus=1 
		<if test="lastUpdateDate !=null  and lastUpdateDate!=''">
		 <![CDATA[
		 	and (lastUpdateDate is NOT null and lastUpdateDate!='')
		 ]]>
		</if>
		
		<if test="lastUpdateDate ==null">
		 <![CDATA[
		 	and (lastUpdateDate is  null or lastUpdateDate='')
		 ]]>
		</if>
		
		<if test="flowDealID !=null  and flowDealID!=''">
		 <![CDATA[
		 and flowDealID like '${flowDealID}%' 
		 ]]>
		</if>
		<if test="SN !=null  and SN !=''">
		 <![CDATA[
		 and SN  LIKE '%${SN}%' 
		]]>
		</if>
		<if test="SN ==null  or SN ==''">
		 <![CDATA[
		 and SN  is not null 
		]]>
		</if>
		<if test="begindateForQuery !=null and begindateForQuery !=''  and enddate!=null and enddate!=''">
		<![CDATA[
			and creatorDate >=#{begindateForQuery} and creatorDate <=#{enddate}
		]]>
		</if>
		group by SN
	</select>
	
	<!-- 取消订单 -->
    <update id="cancelOrder" parameterType="String">
        update FlowDealOrders set orderStatus = '已取消' where orderID = #{orderID}
    </update>
    
    <!-- 更新退款信息 -->
    <update id="updateRefundInfo" parameterType="flowDealOrdersDTO">
        update FlowDealOrders set refundStatus = #{refundStatus},refundAmount = #{refundAmount} where flowDealID = #{flowDealID}
    </update>
    
    <select  id="getFlowOrderbysn" parameterType="String" resultMap="flowDealOrdersDTO">
    	select * from FlowDealOrders where sysStatus=1 and SN=#{SN} and orderStatus in ('可使用','使用中')
    </select>
    
    <sql id="queryTestPage_filter_sql">
        <if test="obj.SN != null and obj.SN != '' ">
            AND SN like '%${obj.SN}%'
	    </if>
	    <if test="obj.begindateForQuery != null and obj.begindateForQuery != '' ">
	        <![CDATA[ AND panlUserDate >= #{obj.begindateForQuery}]]>
	    </if>
	    <if test="obj.enddate != null and obj.enddate != '' ">
	        <![CDATA[ AND panlUserDate <= #{obj.enddate}]]>
	    </if>
	    order by creatorDate desc
    </sql>
    
    <select id="getTestOrderPage" resultMap="flowDealOrdersDTO" parameterType="searchDTO">
        select * from FlowDealOrders where sysStatus=1 and orderID='10086' and customerID='10086' 
        <include refid="queryTestPage_filter_sql"/>
        LIMIT #{startIndex},#{endIndex}
    </select>
    
    <select id="getTestOrderPageCount" resultType="Integer" parameterType="searchDTO">
        select count(*) from FlowDealOrders where sysStatus=1 and orderID='10086' and customerID='10086' 
        <include refid="queryTestPage_filter_sql"/>
    </select>
    
    <update id="updateTestOrderStatus" parameterType="java.util.List">
        update FlowDealOrders set sysStatus=0 where orderID='10086' and customerID='10086' and flowDealID in
        <foreach collection="list" item = "model" open="(" separator="," close=")">
            #{model}
        </foreach>
        and sysStatus = 1
    </update>
    
    <update id="updateTestOrderStatusBySearch" parameterType="flowDealOrdersDTO">
        update FlowDealOrders set sysStatus=0 where sysStatus = 1 and orderID='10086' and customerID='10086' 
        <if test="SN!=null and SN!=''">
            and SN like '%${SN}%' 
        </if>
        <if test="begindateForQuery != null and begindateForQuery != '' ">
            <![CDATA[ AND panlUserDate >= #{begindateForQuery}]]>
        </if>
        <if test="enddate != null and enddate != '' ">
            <![CDATA[ AND panlUserDate <= #{enddate}]]>
        </if>
    </update>
    
    <select id="getorderStatus" parameterType="String" resultType="String">
      select orderStatus from FlowDealOrders where sysStatus=1 and SN=#{SN} order by creatorDate desc limit 1
    </select>
    
    
    <select id="QueryOrderCountByMonth" parameterType="java.util.HashMap" resultType="java.util.Map" statementType="CALLABLE">
		<![CDATA[
    		{call QueryOrderCountByMonth(
    			#{cName,mode=IN,jdbcType=VARCHAR},
    			#{beginDate,mode=IN,jdbcType=VARCHAR},
    			#{endDate,mode=IN,jdbcType=VARCHAR},
    			#{startIndex,mode=IN,jdbcType=INTEGER},
    			#{endIndex,mode=IN,jdbcType=INTEGER}
    		)}
		]]>
	</select>
	
	<update id="updatedrawBackDay" parameterType="flowDealOrdersDTO">
		update FlowDealOrders set drawBackDay=#{drawBackDay} WHERE flowDealID=#{flowDealID}
	</update>
	<select id="getFlowDealOrdersByUsingDate" parameterType="flowDealOrdersDTO" resultMap="flowDealOrdersDTO">
		<![CDATA[  
    		SELECT panlUserDate,flowExpireDate,userCountry,SN,orderStatus,userCountry FROM flowdealorders
			WHERE sysStatus=1
			AND IfFinish='是'
			AND orderStatus IN ('可使用','使用中')
			AND customerID!='10086'
			AND customerID!='10088'
			AND customerID!='10087'
			AND panlUserDate<= '${usingDate}'
			AND flowExpireDate>= '${usingDate}'
		]]>
		<if test="serverCode != null and serverCode != '' ">
			<if test="serverCode == '0'.toString()">
			 	 and  (serverCode IS NULL or serverCode ='') 
			</if>
			<if test="serverCode != '0'.toString()">
				 and  serverCode = ${serverCode}
			</if>
		</if>
	</select>
	
	<!-- 数据交易列表数据导出 -->
	<select id="queryPageExcel2" resultMap="flowDealOrdersDTO" parameterType="flowDealOrdersDTO">
		<!-- <![CDATA[
		SELECT  c.flowOrderID,group_concat(c.userInfo separator ';') AS userInfo,
		fdo.creatorUserName,fdo.customerName,fdo.userCountry,fdo.panlUserDate,fdo.flowExpireDate,fdo.flowDays,fdo.drawBackDay,fdo.orderAmount,fdo.creatorDate,fdo.sn
		FROM (
			SELECT dl.flowOrderID,dl.logsDate,dl.SN,SUM(1) userDays,
			CONCAT_WS(':',(
			CASE
				WHEN  dl.mcc IS NULL OR  dl.mcc ='' THEN  LEFT(dl.location,3) 
				WHEN  dl.mcc  IS NOT NULL OR  dl.mcc !='' THEN  dl.mcc 
			END),SUM(1)) AS userInfo,
		CASE
			WHEN  dl.mcc IS NULL OR  dl.mcc ='' THEN  LEFT(dl.location,3) 
			WHEN  dl.mcc  IS NOT NULL OR  dl.mcc !='' THEN  dl.mcc 
		END AS mcc
		FROM devicelogstemp dl
		LEFT JOIN deviceinfo di ON di.SN=CONVERT(dl.SN USING utf8) COLLATE utf8_unicode_ci
		WHERE  dl.logsDate>='2017-04-01'
		AND dl.logsDate<='2017-04-26'
		AND dl.flowOrderID NOT LIKE '%QD%'
		GROUP BY dl.flowOrderID,mcc
		) c
		LEFT JOIN flowdealorders fdo ON fdo.flowDealID=c.flowOrderID
		WHERE fdo.flowDealID NOT LIKE '%QD%'
		GROUP BY c.flowOrderID
		ORDER BY fdo.creatorDate
		]]> -->
		<![CDATA[
		SELECT  c.flowOrderID,group_concat(c.userInfo separator ';') AS userInfo,
		fdo.creatorUserName,fdo.customerName,fdo.userCountry,fdo.panlUserDate,fdo.flowExpireDate,fdo.flowDays,fdo.drawBackDay,fdo.orderAmount,fdo.creatorDate,fdo.sn
		FROM (
			SELECT dl.flowOrderID,dl.logsDate,dl.SN,SUM(1) userDays,
			CONCAT_WS(':',(
			CASE
				WHEN  dl.mcc IS NULL OR  dl.mcc ='' THEN  LEFT(dl.location,3) 
				WHEN  dl.mcc  IS NOT NULL OR  dl.mcc !='' THEN  dl.mcc 
			END),SUM(1)) AS userInfo,
			CASE
				WHEN  dl.mcc IS NULL OR  dl.mcc ='' THEN  LEFT(dl.location,3) 
				WHEN  dl.mcc  IS NOT NULL OR  dl.mcc !='' THEN  dl.mcc 
			END AS mcc
			FROM devicelogstemp dl
			LEFT JOIN deviceinfo di ON di.SN=CONVERT(dl.SN USING utf8) COLLATE utf8_unicode_ci
		WHERE di.distributorID=#{disId}
		AND dl.logsDate>=#{begindateForQuery}
		AND dl.logsDate<=#{enddate}
		AND dl.flowOrderID LIKE '%${flowDealID}%'
		GROUP BY dl.flowOrderID,mcc
		) c
		LEFT JOIN flowdealorders fdo ON fdo.flowDealID=c.flowOrderID
		WHERE fdo.ifFinish='是'
		AND fdo.flowDealID LIKE '%${flowDealID}%'
		AND fdo.creatorDate >=#{begindateForQuery}
		AND fdo.creatorDate <= #{enddate}
		]]>
		<if test="SN!= null and SN!='' ">
        <![CDATA[
        	AND fdo.sn='%${SN}%'
        ]]>
		</if>
		GROUP BY c.flowOrderID
		ORDER BY fdo.creatorDate
	</select>
	
</mapper>